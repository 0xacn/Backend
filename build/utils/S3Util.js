"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.request = exports.addPremium = exports.updateStorage = exports.wipeFiles = exports.s3 = void 0;
const aws_sdk_1 = require("aws-sdk");
const DomainModel_1 = __importDefault(require("../models/DomainModel"));
const CounterModel_1 = __importDefault(require("../models/CounterModel"));
const axios_1 = __importDefault(require("axios"));
/**
 * The aws-S3 session.
 */
// const s3 = new S3({
//     credentials: {
//         secretAccessKey: process.env.S3_SECRET_KEY,
//         accessKeyId: process.env.S3_ACCESS_KEY_ID,
//     },
//     endpoint: process.env.S3_ENDPOINT,
// });
//minio s3 lol
var s3 = new aws_sdk_1.S3({
    accessKeyId: process.env.S3_ACCESS_KEY_ID,
    secretAccessKey: process.env.S3_SECRET_KEY,
    endpoint: process.env.S3_ENDPOINT,
    s3ForcePathStyle: true,
    signatureVersion: 'v4'
});
exports.s3 = s3;
// the function below is terrible, disgusting, and long, I know, I couldn't really think of any either way to do it and I wanted to release quickly, sorry!
async function updateStorage() {
    try {
        const params = {
            Bucket: process.env.S3_BUCKET,
        };
        let storageUsed = 0;
        let objects = await s3.listObjectsV2(params).promise();
        for (const object of objects.Contents) {
            storageUsed += object.Size;
        }
        await CounterModel_1.default.findByIdAndUpdate('counter', {
            storageUsed: storageUsed,
        });
        setTimeout(async () => {
            await this.updateStorage();
        }, 300000);
    }
    catch (err) {
        new Error(err);
    }
}
exports.updateStorage = updateStorage;
async function request(endpoint, method, body, headers) {
    try {
        const baseUrl = 'https://discord.com/api/v8';
        const { data } = await axios_1.default({
            url: `${baseUrl}${endpoint}`,
            method,
            headers: headers ? headers : null,
            data: body ? body : null,
        });
        return data;
    }
    catch (err) {
        throw new Error("Couldn't link your discord. Please make sure you are not in the 100 server limit");
    }
}
exports.request = request;
async function addPremium(user) {
    await this.request(`/guilds/${process.env.DISCORD_SERVER_ID}/members/${user.discord.id}/roles/806106770212126730`, 'PUT', null, {
        'Authorization': `Bot ${process.env.DISCORD_BOT_TOKEN}`,
    });
}
exports.addPremium = addPremium;
/**
 * Wipe a user's files.
 * @param {user} user The user's files to wipe.
 * @param {string} dir The directory to delete.
 */
async function wipeFiles(user, dir = `${user._id}/`) {
    const domains = await DomainModel_1.default.find({ userOnly: true, donatedBy: user._id });
    let count = 0;
    while (true) {
        const params = {
            Bucket: process.env.S3_BUCKET,
            Prefix: dir,
        };
        if (domains.length !== 0)
            for (const domain of domains) {
                if (domain.userOnly) {
                    params.Prefix = `${domain.name}/`;
                    const domainObjects = await s3.listObjectsV2(params).promise();
                    if (domainObjects.Contents.length !== 0) {
                        const deleteParams = {
                            Bucket: process.env.S3_BUCKET,
                            Delete: {
                                Objects: [],
                            },
                        };
                        for (const { Key } of domainObjects.Contents) {
                            deleteParams.Delete.Objects.push({ Key });
                        }
                        const deleted = await s3.deleteObjects(deleteParams).promise();
                        count += deleted.Deleted.length;
                    }
                }
            }
        params.Prefix = `${user._id}/`;
        const objects = await s3.listObjectsV2(params).promise();
        if (objects.Contents.length !== 0) {
            const deleteParams = {
                Bucket: process.env.S3_BUCKET,
                Delete: {
                    Objects: [],
                },
            };
            for (const { Key } of objects.Contents) {
                deleteParams.Delete.Objects.push({ Key });
            }
            const deleted = await s3.deleteObjects(deleteParams).promise();
            count += deleted.Deleted.length;
        }
        if (!objects.IsTruncated)
            return count;
    }
}
exports.wipeFiles = wipeFiles;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUzNVdGlsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWxzL1MzVXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxxQ0FBNkI7QUFDN0Isd0VBQWdEO0FBRWhELDBFQUFrRDtBQUNsRCxrREFBb0M7QUFFcEM7O0dBRUc7QUFDSCxzQkFBc0I7QUFDdEIscUJBQXFCO0FBQ3JCLHNEQUFzRDtBQUN0RCxxREFBcUQ7QUFDckQsU0FBUztBQUNULHlDQUF5QztBQUN6QyxNQUFNO0FBQ04sY0FBYztBQUNkLElBQUksRUFBRSxHQUFJLElBQUksWUFBRSxDQUFDO0lBQ2IsV0FBVyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCO0lBQ3pDLGVBQWUsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWE7SUFDMUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVztJQUNqQyxnQkFBZ0IsRUFBRSxJQUFJO0lBQ3RCLGdCQUFnQixFQUFFLElBQUk7Q0FDekIsQ0FBQyxDQUFDO0FBOEdDLGdCQUFFO0FBNUdOLDJKQUEySjtBQUMzSixLQUFLLFVBQVUsYUFBYTtJQUN4QixJQUFJO1FBQ0EsTUFBTSxNQUFNLEdBQUc7WUFDWCxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTO1NBQ2hDLENBQUM7UUFDRixJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUM7UUFDcEIsSUFBSSxPQUFPLEdBQUcsTUFBTSxFQUFFLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3ZELEtBQUssTUFBTSxNQUFNLElBQUksT0FBTyxDQUFDLFFBQVEsRUFBRTtZQUNuQyxXQUFXLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQztTQUM5QjtRQUNELE1BQU0sc0JBQVksQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLEVBQUU7WUFDeEMsV0FBVyxFQUFFLFdBQVc7U0FDL0IsQ0FBQyxDQUFBO1FB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YUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO3dCQUMvRCxLQUFLLElBQUssT0FBTyxDQUFDLE9BQWlDLENBQUMsTUFBTSxDQUFDO3FCQUM5RDtpQkFDSjthQUNKO1FBRUQsTUFBTSxDQUFDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQztRQUUvQixNQUFNLE9BQU8sR0FBRyxNQUFNLEVBQUUsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFekQsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDL0IsTUFBTSxZQUFZLEdBQUc7Z0JBQ2pCLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVM7Z0JBQzdCLE1BQU0sRUFBRTtvQkFDSixPQUFPLEVBQUUsRUFBRTtpQkFDZDthQUNKLENBQUM7WUFFRixLQUFLLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxPQUFPLENBQUMsUUFBUSxFQUFFO2dCQUNwQyxZQUFZLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO2FBQzdDO1lBRUQsTUFBTSxPQUFPLEdBQUcsTUFBTSxFQUFFLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQy9ELEtBQUssSUFBSyxPQUFPLENBQUMsT0FBaUMsQ0FBQyxNQUFNLENBQUM7U0FDOUQ7UUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFBRSxPQUFPLEtBQUssQ0FBQztLQUMxQztBQUVMLENBQUM7QUFJRyw4QkFBUyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFMzIH0gZnJvbSAnYXdzLXNkayc7XHJcbmltcG9ydCBEb21haW5Nb2RlbCBmcm9tICcuLi9tb2RlbHMvRG9tYWluTW9kZWwnO1xyXG5pbXBvcnQgeyBVc2VyIH0gZnJvbSAnLi4vbW9kZWxzL1VzZXJNb2RlbCc7XHJcbmltcG9ydCBDb3VudGVyTW9kZWwgZnJvbSBcIi4uL21vZGVscy9Db3VudGVyTW9kZWxcIjtcclxuaW1wb3J0IEF4aW9zLCB7TWV0aG9kfSBmcm9tIFwiYXhpb3NcIjtcclxuXHJcbi8qKlxyXG4gKiBUaGUgYXdzLVMzIHNlc3Npb24uXHJcbiAqL1xyXG4vLyBjb25zdCBzMyA9IG5ldyBTMyh7XHJcbi8vICAgICBjcmVkZW50aWFsczoge1xyXG4vLyAgICAgICAgIHNlY3JldEFjY2Vzc0tleTogcHJvY2Vzcy5lbnYuUzNfU0VDUkVUX0tFWSxcclxuLy8gICAgICAgICBhY2Nlc3NLZXlJZDogcHJvY2Vzcy5lbnYuUzNfQUNDRVNTX0tFWV9JRCxcclxuLy8gICAgIH0sXHJcbi8vICAgICBlbmRwb2ludDogcHJvY2Vzcy5lbnYuUzNfRU5EUE9JTlQsXHJcbi8vIH0pO1xyXG4vL21pbmlvIHMzIGxvbFxyXG52YXIgczMgID0gbmV3IFMzKHtcclxuICAgIGFjY2Vzc0tleUlkOiBwcm9jZXNzLmVudi5TM19BQ0NFU1NfS0VZX0lEICxcclxuICAgIHNlY3JldEFjY2Vzc0tleTogcHJvY2Vzcy5lbnYuUzNfU0VDUkVUX0tFWSxcclxuICAgIGVuZHBvaW50OiBwcm9jZXNzLmVudi5TM19FTkRQT0lOVCAsXHJcbiAgICBzM0ZvcmNlUGF0aFN0eWxlOiB0cnVlLCAvLyBuZWVkZWQgd2l0aCBtaW5pbz9cclxuICAgIHNpZ25hdHVyZVZlcnNpb246ICd2NCdcclxufSk7XHJcblxyXG4vLyB0aGUgZnVuY3Rpb24gYmVsb3cgaXMgdGVycmlibGUsIGRpc2d1c3RpbmcsIGFuZCBsb25nLCBJIGtub3csIEkgY291bGRuJ3QgcmVhbGx5IHRoaW5rIG9mIGFueSBlaXRoZXIgd2F5IHRvIGRvIGl0IGFuZCBJIHdhbnRlZCB0byByZWxlYXNlIHF1aWNrbHksIHNvcnJ5IVxyXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVTdG9yYWdlKCkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBwYXJhbXMgPSB7XHJcbiAgICAgICAgICAgIEJ1Y2tldDogcHJvY2Vzcy5lbnYuUzNfQlVDS0VULFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgbGV0IHN0b3JhZ2VVc2VkID0gMDtcclxuICAgICAgICBsZXQgb2JqZWN0cyA9IGF3YWl0IHMzLmxpc3RPYmplY3RzVjIocGFyYW1zKS5wcm9taXNlKCk7XHJcbiAgICAgICAgZm9yIChjb25zdCBvYmplY3Qgb2Ygb2JqZWN0cy5Db250ZW50cykge1xyXG4gICAgICAgICAgICBzdG9yYWdlVXNlZCArPSBvYmplY3QuU2l6ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYXdhaXQgQ291bnRlck1vZGVsLmZpbmRCeUlkQW5kVXBkYXRlKCdjb3VudGVyJywge1xyXG4gICAgICAgICAgICAgICAgc3RvcmFnZVVzZWQ6IHN0b3JhZ2VVc2VkLFxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgc2V0VGltZW91dChhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGF3YWl0IHRoaXMudXBkYXRlU3RvcmFnZSgpO1xyXG4gICAgICAgIH0sIDMwMDAwMCk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICBuZXcgRXJyb3IoZXJyKVxyXG4gICAgfVxyXG59XHJcbmFzeW5jIGZ1bmN0aW9uIHJlcXVlc3QoZW5kcG9pbnQ6IHN0cmluZywgbWV0aG9kOiBNZXRob2QsIGJvZHk/OiBvYmplY3QgfCBzdHJpbmcsIGhlYWRlcnM/OiBvYmplY3Qpe1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBiYXNlVXJsID0gJ2h0dHBzOi8vZGlzY29yZC5jb20vYXBpL3Y4JztcclxuICAgICAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IEF4aW9zKHtcclxuICAgICAgICAgICAgdXJsOiBgJHtiYXNlVXJsfSR7ZW5kcG9pbnR9YCxcclxuICAgICAgICAgICAgbWV0aG9kLFxyXG4gICAgICAgICAgICBoZWFkZXJzOiBoZWFkZXJzID8gaGVhZGVyczogbnVsbCxcclxuICAgICAgICAgICAgZGF0YTogYm9keSA/IGJvZHkgOiBudWxsLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gZGF0YTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNvdWxkbid0IGxpbmsgeW91ciBkaXNjb3JkLiBQbGVhc2UgbWFrZSBzdXJlIHlvdSBhcmUgbm90IGluIHRoZSAxMDAgc2VydmVyIGxpbWl0XCIpO1xyXG4gICAgfVxyXG59XHJcbmFzeW5jIGZ1bmN0aW9uIGFkZFByZW1pdW0odXNlcjogVXNlcikge1xyXG4gICAgYXdhaXQgdGhpcy5yZXF1ZXN0KGAvZ3VpbGRzLyR7cHJvY2Vzcy5lbnYuRElTQ09SRF9TRVJWRVJfSUR9L21lbWJlcnMvJHt1c2VyLmRpc2NvcmQuaWR9L3JvbGVzLzgwNjEwNjc3MDIxMjEyNjczMGAsICdQVVQnLFxyXG4gICAgICAgIG51bGwsIHtcclxuICAgICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQm90ICR7cHJvY2Vzcy5lbnYuRElTQ09SRF9CT1RfVE9LRU59YCxcclxuICAgICAgICB9XHJcbiAgICApO1xyXG59XHJcbi8qKlxyXG4gKiBXaXBlIGEgdXNlcidzIGZpbGVzLlxyXG4gKiBAcGFyYW0ge3VzZXJ9IHVzZXIgVGhlIHVzZXIncyBmaWxlcyB0byB3aXBlLlxyXG4gKiBAcGFyYW0ge3N0cmluZ30gZGlyIFRoZSBkaXJlY3RvcnkgdG8gZGVsZXRlLlxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gd2lwZUZpbGVzKHVzZXI6IFVzZXIsIGRpcjogc3RyaW5nID0gYCR7dXNlci5faWR9L2ApIHtcclxuICAgIGNvbnN0IGRvbWFpbnMgPSBhd2FpdCBEb21haW5Nb2RlbC5maW5kKHsgdXNlck9ubHk6IHRydWUsIGRvbmF0ZWRCeTogdXNlci5faWQgfSk7XHJcbiAgICBsZXQgY291bnQ6IG51bWJlciA9IDA7XHJcblxyXG4gICAgd2hpbGUgKHRydWUpIHtcclxuICAgICAgICBjb25zdCBwYXJhbXMgPSB7XHJcbiAgICAgICAgICAgIEJ1Y2tldDogcHJvY2Vzcy5lbnYuUzNfQlVDS0VULFxyXG4gICAgICAgICAgICBQcmVmaXg6IGRpcixcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpZiAoZG9tYWlucy5sZW5ndGggIT09IDApIGZvciAoY29uc3QgZG9tYWluIG9mIGRvbWFpbnMpIHtcclxuICAgICAgICAgICAgaWYgKGRvbWFpbi51c2VyT25seSkge1xyXG4gICAgICAgICAgICAgICAgcGFyYW1zLlByZWZpeCA9IGAke2RvbWFpbi5uYW1lfS9gO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IGRvbWFpbk9iamVjdHMgPSBhd2FpdCBzMy5saXN0T2JqZWN0c1YyKHBhcmFtcykucHJvbWlzZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChkb21haW5PYmplY3RzLkNvbnRlbnRzLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlbGV0ZVBhcmFtcyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgQnVja2V0OiBwcm9jZXNzLmVudi5TM19CVUNLRVQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIERlbGV0ZToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0czogW10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCB7IEtleSB9IG9mIGRvbWFpbk9iamVjdHMuQ29udGVudHMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlUGFyYW1zLkRlbGV0ZS5PYmplY3RzLnB1c2goeyBLZXkgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWxldGVkID0gYXdhaXQgczMuZGVsZXRlT2JqZWN0cyhkZWxldGVQYXJhbXMpLnByb21pc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICBjb3VudCArPSAoZGVsZXRlZC5EZWxldGVkIGFzIEFXUy5TMy5EZWxldGVkT2JqZWN0cykubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwYXJhbXMuUHJlZml4ID0gYCR7dXNlci5faWR9L2A7XHJcblxyXG4gICAgICAgIGNvbnN0IG9iamVjdHMgPSBhd2FpdCBzMy5saXN0T2JqZWN0c1YyKHBhcmFtcykucHJvbWlzZSgpO1xyXG5cclxuICAgICAgICBpZiAob2JqZWN0cy5Db250ZW50cy5sZW5ndGggIT09IDApIHtcclxuICAgICAgICAgICAgY29uc3QgZGVsZXRlUGFyYW1zID0ge1xyXG4gICAgICAgICAgICAgICAgQnVja2V0OiBwcm9jZXNzLmVudi5TM19CVUNLRVQsXHJcbiAgICAgICAgICAgICAgICBEZWxldGU6IHtcclxuICAgICAgICAgICAgICAgICAgICBPYmplY3RzOiBbXSxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHsgS2V5IH0gb2Ygb2JqZWN0cy5Db250ZW50cykge1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlUGFyYW1zLkRlbGV0ZS5PYmplY3RzLnB1c2goeyBLZXkgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGRlbGV0ZWQgPSBhd2FpdCBzMy5kZWxldGVPYmplY3RzKGRlbGV0ZVBhcmFtcykucHJvbWlzZSgpO1xyXG4gICAgICAgICAgICBjb3VudCArPSAoZGVsZXRlZC5EZWxldGVkIGFzIEFXUy5TMy5EZWxldGVkT2JqZWN0cykubGVuZ3RoO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCFvYmplY3RzLklzVHJ1bmNhdGVkKSByZXR1cm4gY291bnQ7XHJcbiAgICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQge1xyXG4gICAgczMsXHJcbiAgICB3aXBlRmlsZXMsXHJcbiAgICB1cGRhdGVTdG9yYWdlLFxyXG4gICAgYWRkUHJlbWl1bSxcclxuICAgIHJlcXVlc3RcclxufTtcclxuIl19