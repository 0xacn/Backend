"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const S3Util_1 = require("../../utils/S3Util");
const AuthMiddleware_1 = __importDefault(require("../../middlewares/AuthMiddleware"));
const ValidationMiddleware_1 = __importDefault(require("../../middlewares/ValidationMiddleware"));
const UserModel_1 = __importDefault(require("../../models/UserModel"));
const SettingsRouter_1 = __importDefault(require("./SettingsRouter"));
const FormatUtil_1 = require("../../utils/FormatUtil");
const GenerateUtil_1 = require("../../utils/GenerateUtil");
const InviteModel_1 = __importDefault(require("../../models/InviteModel"));
const RefreshTokenModel_1 = __importDefault(require("../../models/RefreshTokenModel"));
const ChangeUsernameSchema_1 = __importDefault(require("../../schemas/ChangeUsernameSchema"));
const argon2_1 = require("argon2");
const ChangePasswordSchema_1 = __importDefault(require("../../schemas/ChangePasswordSchema"));
const router = express_1.Router();
router.use(AuthMiddleware_1.default);
router.use('/settings', SettingsRouter_1.default);
router.get('/', async (req, res) => {
    const { user } = req;
    res.status(200).json(user);
});
router.get('/images', async (req, res) => {
    const { user } = req;
    try {
        const params = {
            Bucket: process.env.S3_BUCKET,
            Prefix: `${user._id}/`,
        };
        let objects = await S3Util_1.s3.listObjectsV2(params).promise();
        objects.Contents.sort((a, b) => b.LastModified.getTime() - a.LastModified.getTime());
        const images = [];
        let storageUsed = 0;
        for (const object of objects.Contents) {
            storageUsed += object.Size;
            images.push({
                link: `${process.env.S3_ENDPOINT}/${process.env.S3_BUCKET}/${user._id}/${object.Key.split('/')[1]}`,
                dateUploaded: object.LastModified,
                filename: object.Key.split('/')[1],
                size: FormatUtil_1.formatFilesize(object.Size),
            });
        }
        res.status(200).json({
            success: true,
            images,
            storageUsed: FormatUtil_1.formatFilesize(storageUsed),
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
router.post('/disable', async (req, res) => {
    const { user } = req;
    try {
        await UserModel_1.default.findByIdAndUpdate(user._id, {
            blacklisted: {
                status: true,
                reason: 'disabled account',
            },
        });
        await RefreshTokenModel_1.default.deleteMany({ user: user._id });
        res.clearCookie('x-refresh-token');
        res.status(200).json({
            success: true,
            message: 'disabled account successfully',
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
router.post('/regen_key', async (req, res) => {
    const { user } = req;
    try {
        const now = Date.now();
        const difference = user.lastKeyRegen && now - user.lastKeyRegen.getTime();
        const duration = 43200000 - difference;
        if (user.lastKeyRegen && duration > 0) {
            const hours = Math.floor(duration / 1000 / 60 / 60);
            const minutes = Math.floor((duration / 1000 / 60 / 60 - hours) * 60);
            const timeLeft = `${hours} hours and ${minutes} minutes`;
            res.status(400).json({
                success: false,
                error: `you cannot regen your key for another ${timeLeft}`,
            });
            return;
        }
        const key = `${user.username}_${GenerateUtil_1.generateString(30)}`;
        await UserModel_1.default.findByIdAndUpdate(user._id, {
            lastKeyRegen: new Date(),
            key,
        });
        res.status(200).json({
            success: true,
            key,
            message: 'regenerated key successfully',
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
router.get('/created_invites', async (req, res) => {
    const { user } = req;
    try {
        // eslint-disable-next-line quote-props
        const invites = await InviteModel_1.default.find({ 'createdBy.uuid': user._id, useable: true })
            .select('-__v -createdBy');
        res.status(200).json({
            success: true,
            invites,
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
router.put('/change_username', ValidationMiddleware_1.default(ChangeUsernameSchema_1.default), async (req, res) => {
    let { user } = req;
    const { username, password } = req.body;
    try {
        user = await UserModel_1.default.findById(user._id);
        const correctPassword = await argon2_1.verify(user.password, password);
        if (!correctPassword)
            return res.status(401).json({
                success: false,
                error: 'invalid password',
            });
        const now = Date.now();
        const difference = user.lastUsernameChange && now - user.lastUsernameChange.getTime();
        const duration = 1209600000 - difference;
        if (user.lastUsernameChange && duration > 0) {
            const hours = Math.floor(duration / 1000 / 60 / 60);
            const minutes = Math.floor((duration / 1000 / 60 / 60 - hours) * 60);
            const days = Math.floor(hours / 24);
            const timeLeft = `${days} days, ${hours} hours and ${minutes} minutes`;
            res.status(400).json({
                success: false,
                error: `you cannot change your username for another ${timeLeft}`,
            });
            return;
        }
        if (username.toLowerCase() === user.username.toLowerCase())
            return res.status(400).json({
                success: false,
                error: 'provide a new username',
            });
        const usernameTaken = await UserModel_1.default.findOne({ username: { $regex: new RegExp(username, 'i') } });
        if (usernameTaken)
            return res.status(400).json({
                success: false,
                error: 'the provided username is already taken',
            });
        await UserModel_1.default.findByIdAndUpdate(user._id, {
            username,
            lastUsernameChange: new Date(),
        });
        res.status(200).json({
            success: true,
            message: 'changed username successfully',
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
router.put('/change_password', ValidationMiddleware_1.default(ChangePasswordSchema_1.default), async (req, res) => {
    let { user } = req;
    const { newPassword, password } = req.body;
    try {
        user = await UserModel_1.default.findById(user._id);
        const correctPassword = await argon2_1.verify(user.password, password);
        if (!correctPassword)
            return res.status(401).json({
                success: false,
                error: 'invalid password',
            });
        if (await argon2_1.verify(user.password, newPassword))
            return res.status(400).json({
                succes: false,
                error: 'choose a new password',
            });
        const hashed = await argon2_1.hash(newPassword);
        await UserModel_1.default.findByIdAndUpdate(user._id, {
            password: hashed,
        });
        await RefreshTokenModel_1.default.deleteMany({ user: user._id });
        res.status(200).json({
            success: true,
            message: 'changed password successfully',
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
exports.default = router;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWVSb3V0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcm91dGVzL1VzZXJzUm91dGVyL01lUm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEscUNBQW9EO0FBQ3BELCtDQUF3QztBQUN4QyxzRkFBOEQ7QUFDOUQsa0dBQTBFO0FBQzFFLHVFQUErQztBQUMvQyxzRUFBOEM7QUFDOUMsdURBQXdEO0FBQ3hELDJEQUEwRDtBQUMxRCwyRUFBbUQ7QUFFbkQsdUZBQStEO0FBQy9ELDhGQUFzRTtBQUN0RSxtQ0FBc0M7QUFDdEMsOEZBQXNFO0FBRXRFLE1BQU0sTUFBTSxHQUFHLGdCQUFNLEVBQUUsQ0FBQztBQUV4QixNQUFNLENBQUMsR0FBRyxDQUFDLHdCQUFjLENBQUMsQ0FBQztBQUMzQixNQUFNLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSx3QkFBYyxDQUFDLENBQUM7QUFFeEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUNsRCxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsR0FBRyxDQUFDO0lBRXJCLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQy9CLENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUN4RCxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsR0FBRyxDQUFDO0lBQ3JCLElBQUk7UUFDQSxNQUFNLE1BQU0sR0FBRztZQUNYLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVM7WUFDN0IsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsR0FBRztTQUN6QixDQUFDO1FBQ0YsSUFBSSxPQUFPLEdBQUcsTUFBTSxXQUFFLENB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QUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDakIsT0FBTyxFQUFFLElBQUk7WUFDYixPQUFPLEVBQUUsK0JBQStCO1NBQzNDLENBQUMsQ0FBQztLQUNOO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDVixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNqQixPQUFPLEVBQUUsS0FBSztZQUNkLEtBQUssRUFBRSxHQUFHLENBQUMsT0FBTztTQUNyQixDQUFDLENBQUM7S0FDTjtBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsa0JBQWUsTUFBTSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgeyBzMyB9IGZyb20gJy4uLy4uL3V0aWxzL1MzVXRpbCc7XHJcbmltcG9ydCBBdXRoTWlkZGxld2FyZSBmcm9tICcuLi8uLi9taWRkbGV3YXJlcy9BdXRoTWlkZGxld2FyZSc7XHJcbmltcG9ydCBWYWxpZGF0aW9uTWlkZGxld2FyZSBmcm9tICcuLi8uLi9taWRkbGV3YXJlcy9WYWxpZGF0aW9uTWlkZGxld2FyZSc7XHJcbmltcG9ydCBVc2VyTW9kZWwgZnJvbSAnLi4vLi4vbW9kZWxzL1VzZXJNb2RlbCc7XHJcbmltcG9ydCBTZXR0aW5nc1JvdXRlciBmcm9tICcuL1NldHRpbmdzUm91dGVyJztcclxuaW1wb3J0IHsgZm9ybWF0RmlsZXNpemUgfSBmcm9tICcuLi8uLi91dGlscy9Gb3JtYXRVdGlsJztcclxuaW1wb3J0IHsgZ2VuZXJhdGVTdHJpbmcgfSBmcm9tICcuLi8uLi91dGlscy9HZW5lcmF0ZVV0aWwnO1xyXG5pbXBvcnQgSW52aXRlTW9kZWwgZnJvbSAnLi4vLi4vbW9kZWxzL0ludml0ZU1vZGVsJztcclxuaW1wb3J0IERvbWFpbk1vZGVsIGZyb20gJy4uLy4uL21vZGVscy9Eb21haW5Nb2RlbCc7XHJcbmltcG9ydCBSZWZyZXNoVG9rZW5Nb2RlbCBmcm9tICcuLi8uLi9tb2RlbHMvUmVmcmVzaFRva2VuTW9kZWwnO1xyXG5pbXBvcnQgQ2hhbmdlVXNlcm5hbWVTY2hlbWEgZnJvbSAnLi4vLi4vc2NoZW1hcy9DaGFuZ2VVc2VybmFtZVNjaGVtYSc7XHJcbmltcG9ydCB7IGhhc2gsIHZlcmlmeSB9IGZyb20gJ2FyZ29uMic7XHJcbmltcG9ydCBDaGFuZ2VQYXNzd29yZFNjaGVtYSBmcm9tICcuLi8uLi9zY2hlbWFzL0NoYW5nZVBhc3N3b3JkU2NoZW1hJztcclxuaW1wb3J0IHsgZXh0bmFtZSB9IGZyb20gJ3BhdGgnO1xyXG5jb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcclxuXHJcbnJvdXRlci51c2UoQXV0aE1pZGRsZXdhcmUpO1xyXG5yb3V0ZXIudXNlKCcvc2V0dGluZ3MnLCBTZXR0aW5nc1JvdXRlcik7XHJcblxyXG5yb3V0ZXIuZ2V0KCcvJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xyXG4gICAgY29uc3QgeyB1c2VyIH0gPSByZXE7XHJcblxyXG4gICAgcmVzLnN0YXR1cygyMDApLmpzb24odXNlcik7XHJcbn0pO1xyXG5cclxucm91dGVyLmdldCgnL2ltYWdlcycsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgIGNvbnN0IHsgdXNlciB9ID0gcmVxO1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBwYXJhbXMgPSB7XHJcbiAgICAgICAgICAgIEJ1Y2tldDogcHJvY2Vzcy5lbnYuUzNfQlVDS0VULFxyXG4gICAgICAgICAgICBQcmVmaXg6IGAke3VzZXIuX2lkfS9gLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgbGV0IG9iamVjdHMgPSBhd2FpdCBzMy5saXN0T2JqZWN0c1YyKHBhcmFtcykucHJvbWlzZSgpO1xyXG4gICAgICAgIG9iamVjdHMuQ29udGVudHMuc29ydCgoYSwgYikgPT4gYi5MYXN0TW9kaWZpZWQuZ2V0VGltZSgpIC0gYS5MYXN0TW9kaWZpZWQuZ2V0VGltZSgpKTtcclxuICAgICAgICBjb25zdCBpbWFnZXMgPSBbXTtcclxuICAgICAgICBsZXQgc3RvcmFnZVVzZWQgPSAwO1xyXG4gICAgICAgIGZvciAoY29uc3Qgb2JqZWN0IG9mIG9iamVjdHMuQ29udGVudHMpIHtcclxuICAgICAgICAgICAgc3RvcmFnZVVzZWQgKz0gb2JqZWN0LlNpemU7XHJcbiAgICAgICAgICAgIGltYWdlcy5wdXNoKHtcclxuICAgICAgICAgICAgICAgIGxpbms6IGAke3Byb2Nlc3MuZW52LlMzX0VORFBPSU5UfS8ke3Byb2Nlc3MuZW52LlMzX0JVQ0tFVH0vJHt1c2VyLl9pZH0vJHtvYmplY3QuS2V5LnNwbGl0KCcvJylbMV19YCxcclxuICAgICAgICAgICAgICAgIGRhdGVVcGxvYWRlZDogb2JqZWN0Lkxhc3RNb2RpZmllZCxcclxuICAgICAgICAgICAgICAgIGZpbGVuYW1lOiBvYmplY3QuS2V5LnNwbGl0KCcvJylbMV0sXHJcbiAgICAgICAgICAgICAgICBzaXplOiBmb3JtYXRGaWxlc2l6ZShvYmplY3QuU2l6ZSksXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgICAgIGltYWdlcyxcclxuICAgICAgICAgICAgc3RvcmFnZVVzZWQ6IGZvcm1hdEZpbGVzaXplKHN0b3JhZ2VVc2VkKSxcclxuICAgICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgIGVycm9yOiBlcnIubWVzc2FnZSxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufSk7XHJcblxyXG5yb3V0ZXIucG9zdCgnL2Rpc2FibGUnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgICBjb25zdCB7IHVzZXIgfSA9IHJlcTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIGF3YWl0IFVzZXJNb2RlbC5maW5kQnlJZEFuZFVwZGF0ZSh1c2VyLl9pZCwge1xyXG4gICAgICAgICAgICBibGFja2xpc3RlZDoge1xyXG4gICAgICAgICAgICAgICAgc3RhdHVzOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgcmVhc29uOiAnZGlzYWJsZWQgYWNjb3VudCcsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGF3YWl0IFJlZnJlc2hUb2tlbk1vZGVsLmRlbGV0ZU1hbnkoeyB1c2VyOiB1c2VyLl9pZCB9KTtcclxuXHJcbiAgICAgICAgcmVzLmNsZWFyQ29va2llKCd4LXJlZnJlc2gtdG9rZW4nKTtcclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICAgICAgICBtZXNzYWdlOiAnZGlzYWJsZWQgYWNjb3VudCBzdWNjZXNzZnVsbHknLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgZXJyb3I6IGVyci5tZXNzYWdlLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59KTtcclxuXHJcbnJvdXRlci5wb3N0KCcvcmVnZW5fa2V5JywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xyXG4gICAgY29uc3QgeyB1c2VyIH0gPSByZXE7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIGNvbnN0IGRpZmZlcmVuY2UgPSB1c2VyLmxhc3RLZXlSZWdlbiAmJiBub3cgLSB1c2VyLmxhc3RLZXlSZWdlbi5nZXRUaW1lKCk7XHJcbiAgICAgICAgY29uc3QgZHVyYXRpb24gPSA0MzIwMDAwMCAtIGRpZmZlcmVuY2U7XHJcblxyXG4gICAgICAgIGlmICh1c2VyLmxhc3RLZXlSZWdlbiAmJiBkdXJhdGlvbiA+IDApIHtcclxuICAgICAgICAgICAgY29uc3QgaG91cnMgPSBNYXRoLmZsb29yKGR1cmF0aW9uIC8gMTAwMCAvIDYwIC8gNjApO1xyXG4gICAgICAgICAgICBjb25zdCBtaW51dGVzID0gTWF0aC5mbG9vcigoZHVyYXRpb24gLyAxMDAwIC8gNjAgLyA2MCAtIGhvdXJzKSAqIDYwKTtcclxuICAgICAgICAgICAgY29uc3QgdGltZUxlZnQgPSBgJHtob3Vyc30gaG91cnMgYW5kICR7bWludXRlc30gbWludXRlc2A7XHJcblxyXG4gICAgICAgICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XHJcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGVycm9yOiBgeW91IGNhbm5vdCByZWdlbiB5b3VyIGtleSBmb3IgYW5vdGhlciAke3RpbWVMZWZ0fWAsXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3Qga2V5ID0gYCR7dXNlci51c2VybmFtZX1fJHtnZW5lcmF0ZVN0cmluZygzMCl9YDtcclxuXHJcbiAgICAgICAgYXdhaXQgVXNlck1vZGVsLmZpbmRCeUlkQW5kVXBkYXRlKHVzZXIuX2lkLCB7XHJcbiAgICAgICAgICAgIGxhc3RLZXlSZWdlbjogbmV3IERhdGUoKSxcclxuICAgICAgICAgICAga2V5LFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgICAgIGtleSxcclxuICAgICAgICAgICAgbWVzc2FnZTogJ3JlZ2VuZXJhdGVkIGtleSBzdWNjZXNzZnVsbHknLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgZXJyb3I6IGVyci5tZXNzYWdlLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59KTtcclxuXHJcbnJvdXRlci5nZXQoJy9jcmVhdGVkX2ludml0ZXMnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgICBjb25zdCB7IHVzZXIgfSA9IHJlcTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBxdW90ZS1wcm9wc1xyXG4gICAgICAgIGNvbnN0IGludml0ZXMgPSBhd2FpdCBJbnZpdGVNb2RlbC5maW5kKHsgJ2NyZWF0ZWRCeS51dWlkJzogdXNlci5faWQsIHVzZWFibGU6IHRydWUgfSlcclxuICAgICAgICAgICAgLnNlbGVjdCgnLV9fdiAtY3JlYXRlZEJ5Jyk7XHJcblxyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICAgICAgaW52aXRlcyxcclxuICAgICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgIGVycm9yOiBlcnIubWVzc2FnZSxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufSk7XHJcblxyXG5yb3V0ZXIucHV0KCcvY2hhbmdlX3VzZXJuYW1lJywgVmFsaWRhdGlvbk1pZGRsZXdhcmUoQ2hhbmdlVXNlcm5hbWVTY2hlbWEpLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgICBsZXQgeyB1c2VyIH0gPSByZXE7XHJcbiAgICBjb25zdCB7IHVzZXJuYW1lLCBwYXNzd29yZCB9ID0gcmVxLmJvZHk7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgICB1c2VyID0gYXdhaXQgVXNlck1vZGVsLmZpbmRCeUlkKHVzZXIuX2lkKTtcclxuICAgICAgICBjb25zdCBjb3JyZWN0UGFzc3dvcmQgPSBhd2FpdCB2ZXJpZnkodXNlci5wYXNzd29yZCwgcGFzc3dvcmQpO1xyXG5cclxuICAgICAgICBpZiAoIWNvcnJlY3RQYXNzd29yZCkgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgIGVycm9yOiAnaW52YWxpZCBwYXNzd29yZCcsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XHJcbiAgICAgICAgY29uc3QgZGlmZmVyZW5jZSA9IHVzZXIubGFzdFVzZXJuYW1lQ2hhbmdlICYmIG5vdyAtIHVzZXIubGFzdFVzZXJuYW1lQ2hhbmdlLmdldFRpbWUoKTtcclxuICAgICAgICBjb25zdCBkdXJhdGlvbiA9IDEyMDk2MDAwMDAgLSBkaWZmZXJlbmNlO1xyXG5cclxuICAgICAgICBpZiAodXNlci5sYXN0VXNlcm5hbWVDaGFuZ2UgJiYgZHVyYXRpb24gPiAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGhvdXJzID0gTWF0aC5mbG9vcihkdXJhdGlvbiAvIDEwMDAgLyA2MCAvIDYwKTtcclxuICAgICAgICAgICAgY29uc3QgbWludXRlcyA9IE1hdGguZmxvb3IoKGR1cmF0aW9uIC8gMTAwMCAvIDYwIC8gNjAgLSBob3VycykgKiA2MCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRheXMgPSBNYXRoLmZsb29yKGhvdXJzIC8gMjQpO1xyXG4gICAgICAgICAgICBjb25zdCB0aW1lTGVmdCA9IGAke2RheXN9IGRheXMsICR7aG91cnN9IGhvdXJzIGFuZCAke21pbnV0ZXN9IG1pbnV0ZXNgO1xyXG5cclxuICAgICAgICAgICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBlcnJvcjogYHlvdSBjYW5ub3QgY2hhbmdlIHlvdXIgdXNlcm5hbWUgZm9yIGFub3RoZXIgJHt0aW1lTGVmdH1gLFxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh1c2VybmFtZS50b0xvd2VyQ2FzZSgpID09PSB1c2VyLnVzZXJuYW1lLnRvTG93ZXJDYXNlKCkpIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogJ3Byb3ZpZGUgYSBuZXcgdXNlcm5hbWUnLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCB1c2VybmFtZVRha2VuID0gYXdhaXQgVXNlck1vZGVsLmZpbmRPbmUoeyB1c2VybmFtZTogeyAkcmVnZXg6IG5ldyBSZWdFeHAodXNlcm5hbWUsICdpJykgfSB9KTtcclxuXHJcbiAgICAgICAgaWYgKHVzZXJuYW1lVGFrZW4pIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogJ3RoZSBwcm92aWRlZCB1c2VybmFtZSBpcyBhbHJlYWR5IHRha2VuJyxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgYXdhaXQgVXNlck1vZGVsLmZpbmRCeUlkQW5kVXBkYXRlKHVzZXIuX2lkLCB7XHJcbiAgICAgICAgICAgIHVzZXJuYW1lLFxyXG4gICAgICAgICAgICBsYXN0VXNlcm5hbWVDaGFuZ2U6IG5ldyBEYXRlKCksXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICAgICAgbWVzc2FnZTogJ2NoYW5nZWQgdXNlcm5hbWUgc3VjY2Vzc2Z1bGx5JyxcclxuICAgICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgIGVycm9yOiBlcnIubWVzc2FnZSxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufSk7XHJcblxyXG5yb3V0ZXIucHV0KCcvY2hhbmdlX3Bhc3N3b3JkJywgVmFsaWRhdGlvbk1pZGRsZXdhcmUoQ2hhbmdlUGFzc3dvcmRTY2hlbWEpLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgICBsZXQgeyB1c2VyIH0gPSByZXE7XHJcbiAgICBjb25zdCB7IG5ld1Bhc3N3b3JkLCBwYXNzd29yZCB9ID0gcmVxLmJvZHk7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgICB1c2VyID0gYXdhaXQgVXNlck1vZGVsLmZpbmRCeUlkKHVzZXIuX2lkKTtcclxuICAgICAgICBjb25zdCBjb3JyZWN0UGFzc3dvcmQgPSBhd2FpdCB2ZXJpZnkodXNlci5wYXNzd29yZCwgcGFzc3dvcmQpO1xyXG5cclxuICAgICAgICBpZiAoIWNvcnJlY3RQYXNzd29yZCkgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgIGVycm9yOiAnaW52YWxpZCBwYXNzd29yZCcsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGlmIChhd2FpdCB2ZXJpZnkodXNlci5wYXNzd29yZCwgbmV3UGFzc3dvcmQpKSByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXM6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogJ2Nob29zZSBhIG5ldyBwYXNzd29yZCcsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGhhc2hlZCA9IGF3YWl0IGhhc2gobmV3UGFzc3dvcmQpO1xyXG5cclxuICAgICAgICBhd2FpdCBVc2VyTW9kZWwuZmluZEJ5SWRBbmRVcGRhdGUodXNlci5faWQsIHtcclxuICAgICAgICAgICAgcGFzc3dvcmQ6IGhhc2hlZCxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgYXdhaXQgUmVmcmVzaFRva2VuTW9kZWwuZGVsZXRlTWFueSh7IHVzZXI6IHVzZXIuX2lkIH0pO1xyXG5cclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdjaGFuZ2VkIHBhc3N3b3JkIHN1Y2Nlc3NmdWxseScsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogZXJyLm1lc3NhZ2UsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn0pO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgcm91dGVyO1xyXG4iXX0=