"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const argon2_1 = require("argon2");
const express_1 = require("express");
const jsonwebtoken_1 = require("jsonwebtoken");
const uuid_1 = require("uuid");
const GenerateUtil_1 = require("../../utils/GenerateUtil");
const jsonwebtoken_2 = require("jsonwebtoken");
const ValidationMiddleware_1 = __importDefault(require("../../middlewares/ValidationMiddleware"));
const InviteModel_1 = __importDefault(require("../../models/InviteModel"));
const UserModel_1 = __importDefault(require("../../models/UserModel"));
const LoginSchema_1 = __importDefault(require("../../schemas/LoginSchema"));
const RegisterSchema_1 = __importDefault(require("../../schemas/RegisterSchema"));
const VerifyEmailSchema_1 = __importDefault(require("../../schemas/VerifyEmailSchema"));
const DiscordRouter_1 = __importDefault(require("./DiscordRouter"));
const PasswordResetsRouter_1 = __importDefault(require("./PasswordResetsRouter"));
const PasswordResetModel_1 = __importDefault(require("../../models/PasswordResetModel"));
const CounterModel_1 = __importDefault(require("../../models/CounterModel"));
const RefreshTokenModel_1 = __importDefault(require("../../models/RefreshTokenModel"));
const router = express_1.Router();
async function getNextUid() {
    const { count } = await CounterModel_1.default.findByIdAndUpdate('counter', {
        $inc: {
            count: 1,
        },
    });
    return count;
}
router.use('/discord', DiscordRouter_1.default);
router.use('/password_resets', PasswordResetsRouter_1.default);
router.post('/token', async (req, res) => {
    const cookie = req.cookies['x-refresh-token'];
    if (!cookie)
        return res.status(401).json({
            success: false,
            error: 'provide a refresh token',
        });
    try {
        const refreshToken = await RefreshTokenModel_1.default.findOne({ token: cookie });
        if (!refreshToken || Date.now() >= new Date(refreshToken.expires).getTime()) {
            if (refreshToken)
                await refreshToken.remove();
            res.status(401).json({
                success: false,
                error: 'invalid refresh token',
            });
            return;
        }
        const token = jsonwebtoken_2.verify(refreshToken.token, process.env.REFRESH_TOKEN_SECRET);
        const user = await UserModel_1.default.findOne({ _id: token._id })
            .select('-__v -password');
        if (!user)
            return res.status(401).json({
                success: false,
                error: 'invalid refresh token',
            });
        await UserModel_1.default.findByIdAndUpdate(user._id, {
            lastLogin: new Date(),
        });
        const accessToken = jsonwebtoken_1.sign({ _id: user._id }, process.env.ACCESS_TOKEN_SECRET, { expiresIn: '15m' });
        res.status(200).json({
            success: true,
            accessToken,
            user,
        });
    }
    catch (err) {
        res.status(401).json({
            success: false,
            error: 'invalid refresh token',
        });
    }
});
router.post('/register', ValidationMiddleware_1.default(RegisterSchema_1.default), async (req, res) => {
    let { email, username, password, invite } = req.body;
    if (req.user)
        return res.status(400).json({
            success: false,
            error: 'you are already logged in',
        });
    const usernameTaken = await UserModel_1.default.findOne({
        username: { $regex: new RegExp(username, 'i') }
    });
    if (usernameTaken)
        return res.status(400).json({
            success: false,
            error: 'the provided username is already taken',
        });
    const emailTaken = await UserModel_1.default.findOne({ email: { $regex: new RegExp(email, 'i') } });
    if (emailTaken)
        return res.status(400).json({
            success: false,
            error: 'an account has already been registered with this email',
        });
    const inviteDoc = await InviteModel_1.default.findById(invite);
    if (!inviteDoc || !inviteDoc.useable)
        return res.status(400).json({
            success: false,
            error: 'invalid invite code',
        });
    if (inviteDoc.redeemed)
        return res.status(400).json({
            success: false,
            error: 'this invite has already been redeemed',
        });
    let invitedBy = 'Admin';
    const inviter = await UserModel_1.default.findOne({ _id: inviteDoc.createdBy.uuid });
    if (inviter) {
        invitedBy = inviter.username;
        await UserModel_1.default.findByIdAndUpdate(inviter._id, {
            $push: {
                invitedUsers: username,
            },
        });
        await InviteModel_1.default.findByIdAndUpdate(invite, {
            usedBy: username,
            redeemed: true,
            useable: false,
        });
    }
    password = await argon2_1.hash(password);
    try {
        const user = await UserModel_1.default.create({
            _id: uuid_1.v4(),
            uid: await getNextUid(),
            username,
            password,
            invite,
            key: `${username}_${GenerateUtil_1.generateString(30)}`,
            premium: false,
            lastDomainAddition: null,
            lastKeyRegen: null,
            lastUsernameChange: null,
            lastFileArchive: null,
            email,
            emailVerified: true,
            emailVerificationKey: GenerateUtil_1.generateString(30),
            discord: {
                id: null,
                avatar: null,
            },
            strikes: 0,
            blacklisted: {
                status: false,
                reason: null,
            },
            uploads: 0,
            invites: 0,
            invitedBy,
            invitedUsers: [],
            registrationDate: new Date(),
            lastLogin: null,
            testimonial: null,
            admin: false,
            notifications: [],
            settings: {
                domain: {
                    name: 'i.dny.wtf',
                    subdomain: null,
                },
                randomDomain: {
                    enabled: false,
                    domains: [],
                },
                embed: {
                    enabled: true,
                    color: '#13ed7c',
                    title: 'default',
                    description: 'default',
                    author: 'default',
                    randomColor: true,
                },
                autoWipe: {
                    enabled: false,
                    interval: 3600000,
                },
                showLink: false,
                invisibleUrl: false,
                longUrl: false,
            },
        });
        await user.save();
        res.status(200).json({
            success: true,
            message: 'registered successfully, please login',
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
router.post('/login', ValidationMiddleware_1.default(LoginSchema_1.default), async (req, res) => {
    const { username, password } = req.body;
    const user = await UserModel_1.default.findOne({ username });
    if (!user || !(user.password.startsWith('$') ? await argon2_1.verify(user.password, password) : false))
        return res.status(401).json({
            success: false,
            error: 'invalid username or password',
        });
    if (!user.emailVerified)
        return res.status(401).json({
            success: false,
            error: 'your email is not verified',
        });
    if (user.blacklisted.status)
        return res.status(401).json({
            success: false,
            error: `you are blacklisted for: ${user.blacklisted.reason}`,
        });
    try {
        const passwordReset = await PasswordResetModel_1.default.findOne({ user: user._id });
        if (passwordReset)
            await passwordReset.remove();
        await UserModel_1.default.findByIdAndUpdate(user._id, {
            lastLogin: new Date(),
        });
        const accessToken = jsonwebtoken_1.sign({ _id: user._id }, process.env.ACCESS_TOKEN_SECRET, { expiresIn: '15m' });
        const refreshToken = jsonwebtoken_1.sign({ _id: user._id }, process.env.REFRESH_TOKEN_SECRET);
        await RefreshTokenModel_1.default.create({
            token: refreshToken,
            user: user._id,
            expires: new Date(new Date().getTime() + 7 * 24 * 60 * 60 * 1000),
        });
        res.cookie('x-refresh-token', refreshToken, { httpOnly: true, secure: false });
        res.status(200).json({
            success: true,
            accessToken,
            user: await UserModel_1.default.findById(user._id).select('-__v -password'),
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
router.get('/logout', async (req, res) => {
    const cookie = req.cookies['x-refresh-token'];
    if (!cookie)
        return res.status(401).json({
            success: false,
            error: 'unauthorized',
        });
    try {
        const refreshToken = await RefreshTokenModel_1.default.findOne({ token: cookie });
        if (!refreshToken)
            return res.status(401).json({
                success: false,
                error: 'unauthorized',
            });
        await refreshToken.remove();
        res.clearCookie('x-refresh-token');
        res.status(200).json({
            success: true,
            message: 'logged out successfully',
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
router.get('/verify', ValidationMiddleware_1.default(VerifyEmailSchema_1.default, 'query'), async (req, res) => {
    const key = req.query.key;
    const user = await UserModel_1.default.findOne({ emailVerificationKey: key });
    if (!user)
        return res.status(404).json({
            success: false,
            error: 'invalid verification key',
        });
    if (user.emailVerified)
        return res.status(400).json({
            success: false,
            error: 'your email is already verified',
        });
    try {
        await UserModel_1.default.findByIdAndUpdate(user._id, {
            emailVerified: true,
        });
        res.status(200).json({
            success: true,
            message: 'verified email successfully',
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
router.post('/logout_all_devices', async (req, res) => {
});
exports.default = router;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcm91dGVzL0F1dGhSb3V0ZXIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxtQ0FBc0M7QUFDdEMscUNBQW9EO0FBQ3BELCtDQUFvQztBQUNwQywrQkFBa0M7QUFDbEMsMkRBQTBEO0FBQzFELCtDQUFtRDtBQUNuRCxrR0FBMEU7QUFDMUUsMkVBQW1EO0FBQ25ELHVFQUErQztBQUMvQyw0RUFBb0Q7QUFDcEQsa0ZBQTBEO0FBQzFELHdGQUFnRTtBQUNoRSxvRUFBNEM7QUFDNUMsa0ZBQTBEO0FBQzFELHlGQUFpRTtBQUNqRSw2RUFBcUQ7QUFDckQsdUZBQStEO0FBQy9ELE1BQU0sTUFBTSxHQUFHLGdCQUFNLEVBQUUsQ0FBQztBQUV4QixLQUFLLFVBQVUsVUFBVTtJQUNyQixNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSxzQkFBWSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsRUFBRTtRQUM5RCxJQUFJLEVBQUU7WUFDRixLQUFLLEVBQUUsQ0FBQztTQUNYO0tBQ0osQ0FBQyxDQUFDO0lBRUgsT0FBTyxLQUFLLENBQUM7QUFDakIsQ0FBQztBQUVELE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLHVCQUFhLENBQUMsQ0FBQztBQUN0QyxNQUFNLENBQUMsR0FBRyxDQUFDLGtCQUFrQixFQUFFLDhCQUFvQixDQUFDLENBQUM7QUFFckQsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUN4RCxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFFOUMsSUFBSSxDQUFDLE1BQU07UUFBRSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ3JDLE9BQU8sRUFBRSxLQUFLO1lBQ2Qs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Q3JCLENBQUMsQ0FBQztLQUNOO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7QUFFekUsQ0FBQyxDQUFDLENBQUM7QUFFSCxrQkFBZSxNQUFNLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBoYXNoLCB2ZXJpZnkgfSBmcm9tICdhcmdvbjInO1xyXG5pbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgUm91dGVyIH0gZnJvbSAnZXhwcmVzcyc7XHJcbmltcG9ydCB7IHNpZ24gfSBmcm9tICdqc29ud2VidG9rZW4nO1xyXG5pbXBvcnQgeyB2NCBhcyB1dWlkIH0gZnJvbSAndXVpZCc7XHJcbmltcG9ydCB7IGdlbmVyYXRlU3RyaW5nIH0gZnJvbSAnLi4vLi4vdXRpbHMvR2VuZXJhdGVVdGlsJztcclxuaW1wb3J0IHsgdmVyaWZ5IGFzIHZlcmlmeWp3dCB9IGZyb20gJ2pzb253ZWJ0b2tlbic7XHJcbmltcG9ydCBWYWxpZGF0aW9uTWlkZGxld2FyZSBmcm9tICcuLi8uLi9taWRkbGV3YXJlcy9WYWxpZGF0aW9uTWlkZGxld2FyZSc7XHJcbmltcG9ydCBJbnZpdGVNb2RlbCBmcm9tICcuLi8uLi9tb2RlbHMvSW52aXRlTW9kZWwnO1xyXG5pbXBvcnQgVXNlck1vZGVsIGZyb20gJy4uLy4uL21vZGVscy9Vc2VyTW9kZWwnO1xyXG5pbXBvcnQgTG9naW5TY2hlbWEgZnJvbSAnLi4vLi4vc2NoZW1hcy9Mb2dpblNjaGVtYSc7XHJcbmltcG9ydCBSZWdpc3RlclNjaGVtYSBmcm9tICcuLi8uLi9zY2hlbWFzL1JlZ2lzdGVyU2NoZW1hJztcclxuaW1wb3J0IFZlcmlmeUVtYWlsU2NoZW1hIGZyb20gJy4uLy4uL3NjaGVtYXMvVmVyaWZ5RW1haWxTY2hlbWEnO1xyXG5pbXBvcnQgRGlzY29yZFJvdXRlciBmcm9tICcuL0Rpc2NvcmRSb3V0ZXInO1xyXG5pbXBvcnQgUGFzc3dvcmRSZXNldHNSb3V0ZXIgZnJvbSAnLi9QYXNzd29yZFJlc2V0c1JvdXRlcic7XHJcbmltcG9ydCBQYXNzd29yZFJlc2V0TW9kZWwgZnJvbSAnLi4vLi4vbW9kZWxzL1Bhc3N3b3JkUmVzZXRNb2RlbCc7XHJcbmltcG9ydCBDb3VudGVyTW9kZWwgZnJvbSAnLi4vLi4vbW9kZWxzL0NvdW50ZXJNb2RlbCc7XHJcbmltcG9ydCBSZWZyZXNoVG9rZW5Nb2RlbCBmcm9tICcuLi8uLi9tb2RlbHMvUmVmcmVzaFRva2VuTW9kZWwnO1xyXG5jb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGdldE5leHRVaWQoKSB7XHJcbiAgICBjb25zdCB7IGNvdW50IH0gPSBhd2FpdCBDb3VudGVyTW9kZWwuZmluZEJ5SWRBbmRVcGRhdGUoJ2NvdW50ZXInLCB7XHJcbiAgICAgICAgJGluYzoge1xyXG4gICAgICAgICAgICBjb3VudDogMSxcclxuICAgICAgICB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGNvdW50O1xyXG59XHJcblxyXG5yb3V0ZXIudXNlKCcvZGlzY29yZCcsIERpc2NvcmRSb3V0ZXIpO1xyXG5yb3V0ZXIudXNlKCcvcGFzc3dvcmRfcmVzZXRzJywgUGFzc3dvcmRSZXNldHNSb3V0ZXIpO1xyXG5cclxucm91dGVyLnBvc3QoJy90b2tlbicsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgIGNvbnN0IGNvb2tpZSA9IHJlcS5jb29raWVzWyd4LXJlZnJlc2gtdG9rZW4nXTtcclxuXHJcbiAgICBpZiAoIWNvb2tpZSkgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogJ3Byb3ZpZGUgYSByZWZyZXNoIHRva2VuJyxcclxuICAgIH0pO1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgcmVmcmVzaFRva2VuID0gYXdhaXQgUmVmcmVzaFRva2VuTW9kZWwuZmluZE9uZSh7IHRva2VuOiBjb29raWUgfSk7XHJcblxyXG4gICAgICAgIGlmICghcmVmcmVzaFRva2VuIHx8IERhdGUubm93KCkgPj0gbmV3IERhdGUocmVmcmVzaFRva2VuLmV4cGlyZXMpLmdldFRpbWUoKSkge1xyXG4gICAgICAgICAgICBpZiAocmVmcmVzaFRva2VuKSBhd2FpdCByZWZyZXNoVG9rZW4ucmVtb3ZlKCk7XHJcblxyXG4gICAgICAgICAgICByZXMuc3RhdHVzKDQwMSkuanNvbih7XHJcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGVycm9yOiAnaW52YWxpZCByZWZyZXNoIHRva2VuJyxcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB0b2tlbjogYW55ID0gdmVyaWZ5and0KHJlZnJlc2hUb2tlbi50b2tlbiwgcHJvY2Vzcy5lbnYuUkVGUkVTSF9UT0tFTl9TRUNSRVQpO1xyXG5cclxuICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlck1vZGVsLmZpbmRPbmUoeyBfaWQ6IHRva2VuLl9pZCB9KVxyXG4gICAgICAgICAgICAuc2VsZWN0KCctX192IC1wYXNzd29yZCcpO1xyXG5cclxuICAgICAgICBpZiAoIXVzZXIpIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogJ2ludmFsaWQgcmVmcmVzaCB0b2tlbicsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGF3YWl0IFVzZXJNb2RlbC5maW5kQnlJZEFuZFVwZGF0ZSh1c2VyLl9pZCwge1xyXG4gICAgICAgICAgICBsYXN0TG9naW46IG5ldyBEYXRlKCksXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gc2lnbih7IF9pZDogdXNlci5faWQgfSwgcHJvY2Vzcy5lbnYuQUNDRVNTX1RPS0VOX1NFQ1JFVCwgeyBleHBpcmVzSW46ICcxNW0nIH0pO1xyXG5cclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgICAgIGFjY2Vzc1Rva2VuLFxyXG4gICAgICAgICAgICB1c2VyLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgZXJyb3I6ICdpbnZhbGlkIHJlZnJlc2ggdG9rZW4nLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59KTtcclxuXHJcbnJvdXRlci5wb3N0KCcvcmVnaXN0ZXInLCBWYWxpZGF0aW9uTWlkZGxld2FyZShSZWdpc3RlclNjaGVtYSksIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgIGxldCB7IGVtYWlsLCB1c2VybmFtZSwgcGFzc3dvcmQsIGludml0ZSB9OiB7XHJcbiAgICAgICAgZW1haWw6IHN0cmluZztcclxuICAgICAgICB1c2VybmFtZTogc3RyaW5nO1xyXG4gICAgICAgIHBhc3N3b3JkOiBzdHJpbmc7XHJcbiAgICAgICAgaW52aXRlOiBzdHJpbmc7XHJcbiAgICB9ID0gcmVxLmJvZHk7XHJcblxyXG4gICAgaWYgKHJlcS51c2VyKSByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xyXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgIGVycm9yOiAneW91IGFyZSBhbHJlYWR5IGxvZ2dlZCBpbicsXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCB1c2VybmFtZVRha2VuID0gYXdhaXQgVXNlck1vZGVsLmZpbmRPbmUoe1xyXG4gICAgICAgIHVzZXJuYW1lOiB7ICRyZWdleDogbmV3IFJlZ0V4cCh1c2VybmFtZSwgJ2knKSB9IH1cclxuICAgICAgICApO1xyXG5cclxuICAgIGlmICh1c2VybmFtZVRha2VuKSByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xyXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgIGVycm9yOiAndGhlIHByb3ZpZGVkIHVzZXJuYW1lIGlzIGFscmVhZHkgdGFrZW4nLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgZW1haWxUYWtlbiA9IGF3YWl0IFVzZXJNb2RlbC5maW5kT25lKHsgZW1haWw6IHsgJHJlZ2V4OiBuZXcgUmVnRXhwKGVtYWlsLCAnaScpIH0gfSk7XHJcblxyXG4gICAgaWYgKGVtYWlsVGFrZW4pIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgZXJyb3I6ICdhbiBhY2NvdW50IGhhcyBhbHJlYWR5IGJlZW4gcmVnaXN0ZXJlZCB3aXRoIHRoaXMgZW1haWwnLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgaW52aXRlRG9jID0gYXdhaXQgSW52aXRlTW9kZWwuZmluZEJ5SWQoaW52aXRlKTtcclxuXHJcbiAgICBpZiAoIWludml0ZURvYyB8fCAhaW52aXRlRG9jLnVzZWFibGUpIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgZXJyb3I6ICdpbnZhbGlkIGludml0ZSBjb2RlJyxcclxuICAgIH0pO1xyXG5cclxuICAgIGlmIChpbnZpdGVEb2MucmVkZWVtZWQpIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgZXJyb3I6ICd0aGlzIGludml0ZSBoYXMgYWxyZWFkeSBiZWVuIHJlZGVlbWVkJyxcclxuICAgIH0pO1xyXG5cclxuICAgIGxldCBpbnZpdGVkQnkgPSAnQWRtaW4nO1xyXG4gICAgY29uc3QgaW52aXRlciA9IGF3YWl0IFVzZXJNb2RlbC5maW5kT25lKHsgX2lkOiBpbnZpdGVEb2MuY3JlYXRlZEJ5LnV1aWQgfSk7XHJcblxyXG4gICAgaWYgKGludml0ZXIpIHtcclxuICAgICAgICBpbnZpdGVkQnkgPSBpbnZpdGVyLnVzZXJuYW1lO1xyXG5cclxuICAgICAgICBhd2FpdCBVc2VyTW9kZWwuZmluZEJ5SWRBbmRVcGRhdGUoaW52aXRlci5faWQsIHtcclxuICAgICAgICAgICAgJHB1c2g6IHtcclxuICAgICAgICAgICAgICAgIGludml0ZWRVc2VyczogdXNlcm5hbWUsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgYXdhaXQgSW52aXRlTW9kZWwuZmluZEJ5SWRBbmRVcGRhdGUoaW52aXRlLCB7XHJcbiAgICAgICAgICAgIHVzZWRCeTogdXNlcm5hbWUsXHJcbiAgICAgICAgICAgIHJlZGVlbWVkOiB0cnVlLFxyXG4gICAgICAgICAgICB1c2VhYmxlOiBmYWxzZSxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwYXNzd29yZCA9IGF3YWl0IGhhc2gocGFzc3dvcmQpO1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXJNb2RlbC5jcmVhdGUoe1xyXG4gICAgICAgICAgICBfaWQ6IHV1aWQoKSxcclxuICAgICAgICAgICAgdWlkOiBhd2FpdCBnZXROZXh0VWlkKCksXHJcbiAgICAgICAgICAgIHVzZXJuYW1lLFxyXG4gICAgICAgICAgICBwYXNzd29yZCxcclxuICAgICAgICAgICAgaW52aXRlLFxyXG4gICAgICAgICAgICBrZXk6IGAke3VzZXJuYW1lfV8ke2dlbmVyYXRlU3RyaW5nKDMwKX1gLFxyXG4gICAgICAgICAgICBwcmVtaXVtOiBmYWxzZSxcclxuICAgICAgICAgICAgbGFzdERvbWFpbkFkZGl0aW9uOiBudWxsLFxyXG4gICAgICAgICAgICBsYXN0S2V5UmVnZW46IG51bGwsXHJcbiAgICAgICAgICAgIGxhc3RVc2VybmFtZUNoYW5nZTogbnVsbCxcclxuICAgICAgICAgICAgbGFzdEZpbGVBcmNoaXZlOiBudWxsLFxyXG4gICAgICAgICAgICBlbWFpbCxcclxuICAgICAgICAgICAgZW1haWxWZXJpZmllZDogdHJ1ZSxcclxuICAgICAgICAgICAgZW1haWxWZXJpZmljYXRpb25LZXk6IGdlbmVyYXRlU3RyaW5nKDMwKSxcclxuICAgICAgICAgICAgZGlzY29yZDoge1xyXG4gICAgICAgICAgICAgICAgaWQ6IG51bGwsXHJcbiAgICAgICAgICAgICAgICBhdmF0YXI6IG51bGwsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHN0cmlrZXM6IDAsXHJcbiAgICAgICAgICAgIGJsYWNrbGlzdGVkOiB7XHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgcmVhc29uOiBudWxsLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB1cGxvYWRzOiAwLFxyXG4gICAgICAgICAgICBpbnZpdGVzOiAwLFxyXG4gICAgICAgICAgICBpbnZpdGVkQnksXHJcbiAgICAgICAgICAgIGludml0ZWRVc2VyczogW10sXHJcbiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbkRhdGU6IG5ldyBEYXRlKCksXHJcbiAgICAgICAgICAgIGxhc3RMb2dpbjogbnVsbCxcclxuICAgICAgICAgICAgdGVzdGltb25pYWw6IG51bGwsXHJcbiAgICAgICAgICAgIGFkbWluOiBmYWxzZSxcclxuICAgICAgICAgICAgbm90aWZpY2F0aW9uczogW10sXHJcbiAgICAgICAgICAgIHNldHRpbmdzOiB7XHJcbiAgICAgICAgICAgICAgICBkb21haW46IHtcclxuICAgICAgICAgICAgICAgICAgICBuYW1lOiAnaS5kbnkud3RmJyxcclxuICAgICAgICAgICAgICAgICAgICBzdWJkb21haW46IG51bGwsXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgcmFuZG9tRG9tYWluOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZW5hYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgZG9tYWluczogW10sXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgZW1iZWQ6IHtcclxuICAgICAgICAgICAgICAgICAgICBlbmFibGVkOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbG9yOiAnIzEzZWQ3YycsXHJcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6ICdkZWZhdWx0JyxcclxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ2RlZmF1bHQnLFxyXG4gICAgICAgICAgICAgICAgICAgIGF1dGhvcjogJ2RlZmF1bHQnLFxyXG4gICAgICAgICAgICAgICAgICAgIHJhbmRvbUNvbG9yOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGF1dG9XaXBlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZW5hYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWw6IDM2MDAwMDAsXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgc2hvd0xpbms6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgaW52aXNpYmxlVXJsOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGxvbmdVcmw6IGZhbHNlLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBhd2FpdCB1c2VyLnNhdmUoKTtcclxuXHJcblxyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICAgICAgbWVzc2FnZTogJ3JlZ2lzdGVyZWQgc3VjY2Vzc2Z1bGx5LCBwbGVhc2UgbG9naW4nLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgZXJyb3I6IGVyci5tZXNzYWdlLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59KTtcclxuXHJcbnJvdXRlci5wb3N0KCcvbG9naW4nLCBWYWxpZGF0aW9uTWlkZGxld2FyZShMb2dpblNjaGVtYSksIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgIGNvbnN0IHsgdXNlcm5hbWUsIHBhc3N3b3JkIH06IHtcclxuICAgICAgICB1c2VybmFtZTogc3RyaW5nO1xyXG4gICAgICAgIHBhc3N3b3JkOiBzdHJpbmc7XHJcbiAgICB9ID0gcmVxLmJvZHk7XHJcblxyXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXJNb2RlbC5maW5kT25lKHsgdXNlcm5hbWUgfSk7XHJcblxyXG4gICAgaWYgKCF1c2VyIHx8ICEodXNlci5wYXNzd29yZC5zdGFydHNXaXRoKCckJykgPyBhd2FpdCB2ZXJpZnkodXNlci5wYXNzd29yZCwgcGFzc3dvcmQpIDogZmFsc2UpKSByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xyXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgIGVycm9yOiAnaW52YWxpZCB1c2VybmFtZSBvciBwYXNzd29yZCcsXHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoIXVzZXIuZW1haWxWZXJpZmllZCkgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogJ3lvdXIgZW1haWwgaXMgbm90IHZlcmlmaWVkJyxcclxuICAgIH0pO1xyXG5cclxuICAgIGlmICh1c2VyLmJsYWNrbGlzdGVkLnN0YXR1cykgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogYHlvdSBhcmUgYmxhY2tsaXN0ZWQgZm9yOiAke3VzZXIuYmxhY2tsaXN0ZWQucmVhc29ufWAsXHJcbiAgICB9KTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHBhc3N3b3JkUmVzZXQgPSBhd2FpdCBQYXNzd29yZFJlc2V0TW9kZWwuZmluZE9uZSh7IHVzZXI6IHVzZXIuX2lkIH0pO1xyXG4gICAgICAgIGlmIChwYXNzd29yZFJlc2V0KSBhd2FpdCBwYXNzd29yZFJlc2V0LnJlbW92ZSgpO1xyXG5cclxuICAgICAgICBhd2FpdCBVc2VyTW9kZWwuZmluZEJ5SWRBbmRVcGRhdGUodXNlci5faWQsIHtcclxuICAgICAgICAgICAgbGFzdExvZ2luOiBuZXcgRGF0ZSgpLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IHNpZ24oeyBfaWQ6IHVzZXIuX2lkIH0sIHByb2Nlc3MuZW52LkFDQ0VTU19UT0tFTl9TRUNSRVQsIHsgZXhwaXJlc0luOiAnMTVtJyB9KTtcclxuICAgICAgICBjb25zdCByZWZyZXNoVG9rZW4gPSBzaWduKHsgX2lkOiB1c2VyLl9pZCB9LCBwcm9jZXNzLmVudi5SRUZSRVNIX1RPS0VOX1NFQ1JFVCk7XHJcblxyXG4gICAgICAgIGF3YWl0IFJlZnJlc2hUb2tlbk1vZGVsLmNyZWF0ZSh7XHJcbiAgICAgICAgICAgIHRva2VuOiByZWZyZXNoVG9rZW4sXHJcbiAgICAgICAgICAgIHVzZXI6IHVzZXIuX2lkLFxyXG4gICAgICAgICAgICBleHBpcmVzOiBuZXcgRGF0ZShuZXcgRGF0ZSgpLmdldFRpbWUoKSArIDcgKiAyNCAqIDYwICogNjAgKiAxMDAwKSxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmVzLmNvb2tpZSgneC1yZWZyZXNoLXRva2VuJywgcmVmcmVzaFRva2VuLCB7IGh0dHBPbmx5OiB0cnVlLCBzZWN1cmU6IGZhbHNlIH0pO1xyXG5cclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgICAgIGFjY2Vzc1Rva2VuLFxyXG4gICAgICAgICAgICB1c2VyOiBhd2FpdCBVc2VyTW9kZWwuZmluZEJ5SWQodXNlci5faWQpLnNlbGVjdCgnLV9fdiAtcGFzc3dvcmQnKSxcclxuICAgICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgIGVycm9yOiBlcnIubWVzc2FnZSxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufSk7XHJcblxyXG5yb3V0ZXIuZ2V0KCcvbG9nb3V0JywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xyXG4gICAgY29uc3QgY29va2llID0gcmVxLmNvb2tpZXNbJ3gtcmVmcmVzaC10b2tlbiddO1xyXG5cclxuICAgIGlmICghY29va2llKSByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xyXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgIGVycm9yOiAndW5hdXRob3JpemVkJyxcclxuICAgIH0pO1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgcmVmcmVzaFRva2VuID0gYXdhaXQgUmVmcmVzaFRva2VuTW9kZWwuZmluZE9uZSh7IHRva2VuOiBjb29raWUgfSk7XHJcblxyXG4gICAgICAgIGlmICghcmVmcmVzaFRva2VuKSByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgZXJyb3I6ICd1bmF1dGhvcml6ZWQnLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBhd2FpdCByZWZyZXNoVG9rZW4ucmVtb3ZlKCk7XHJcbiAgICAgICAgcmVzLmNsZWFyQ29va2llKCd4LXJlZnJlc2gtdG9rZW4nKTtcclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICAgICAgICBtZXNzYWdlOiAnbG9nZ2VkIG91dCBzdWNjZXNzZnVsbHknLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgZXJyb3I6IGVyci5tZXNzYWdlLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59KTtcclxuXHJcbnJvdXRlci5nZXQoJy92ZXJpZnknLCBWYWxpZGF0aW9uTWlkZGxld2FyZShWZXJpZnlFbWFpbFNjaGVtYSwgJ3F1ZXJ5JyksIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgIGNvbnN0IGtleSA9IHJlcS5xdWVyeS5rZXkgYXMgc3RyaW5nO1xyXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXJNb2RlbC5maW5kT25lKHsgZW1haWxWZXJpZmljYXRpb25LZXk6IGtleSB9KTtcclxuXHJcbiAgICBpZiAoIXVzZXIpIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgZXJyb3I6ICdpbnZhbGlkIHZlcmlmaWNhdGlvbiBrZXknLFxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKHVzZXIuZW1haWxWZXJpZmllZCkgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogJ3lvdXIgZW1haWwgaXMgYWxyZWFkeSB2ZXJpZmllZCcsXHJcbiAgICB9KTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIGF3YWl0IFVzZXJNb2RlbC5maW5kQnlJZEFuZFVwZGF0ZSh1c2VyLl9pZCwge1xyXG4gICAgICAgICAgICBlbWFpbFZlcmlmaWVkOiB0cnVlLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgICAgIG1lc3NhZ2U6ICd2ZXJpZmllZCBlbWFpbCBzdWNjZXNzZnVsbHknLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgZXJyb3I6IGVyci5tZXNzYWdlLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59KTtcclxuXHJcbnJvdXRlci5wb3N0KCcvbG9nb3V0X2FsbF9kZXZpY2VzJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xyXG5cclxufSk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCByb3V0ZXI7XHJcbiJdfQ==