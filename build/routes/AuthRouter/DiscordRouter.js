"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const jsonwebtoken_1 = require("jsonwebtoken");
const OAuthMiddleware_1 = __importDefault(require("../../middlewares/OAuthMiddleware"));
const PasswordResetModel_1 = __importDefault(require("../../models/PasswordResetModel"));
const RefreshTokenModel_1 = __importDefault(require("../../models/RefreshTokenModel"));
const UserModel_1 = __importDefault(require("../../models/UserModel"));
const router = express_1.Router();
router.get('/login', (req, res) => {
    const cookie = req.cookies['x-refresh-token'];
    cookie ?
        res.redirect(`${process.env.FRONTEND_URL}/dashboard`) :
        res.redirect(process.env.DISCORD_LOGIN_URL);
});
router.get('/login/callback', OAuthMiddleware_1.default(), async (req, res) => {
    const { id, avatar, discriminator } = req.discord.user;
    try {
        const user = await UserModel_1.default.findOne({ 'discord.id': id });
        if (!user || !user.emailVerified || user.blacklisted.status)
            return res.status(401).redirect(process.env.FRONTEND_URL);
        const passwordReset = await PasswordResetModel_1.default.findOne({ user: user._id });
        if (passwordReset)
            await passwordReset.remove();
        let avatarurl;
        if (avatar && avatar.startsWith("a_")) {
            avatarurl = `https://cdn.discordapp.com/${avatar ? `avatars/${id}/${avatar}` : `embed/avatars/${discriminator % 5}`}.gif`;
        }
        else {
            avatarurl = `https://cdn.discordapp.com/${avatar ? `avatars/${id}/${avatar}` : `embed/avatars/${discriminator % 5}`}.png`;
        }
        const update = {
            'lastLogin': new Date(),
            'discord.avatar': avatarurl,
        };
        await UserModel_1.default.findByIdAndUpdate(user._id, update);
        const refreshToken = jsonwebtoken_1.sign({ _id: user._id }, process.env.REFRESH_TOKEN_SECRET);
        await RefreshTokenModel_1.default.create({
            token: refreshToken,
            user: user._id,
            expires: new Date(new Date().getTime() + 7 * 24 * 60 * 60 * 1000),
        });
        res.cookie('x-refresh-token', refreshToken, { httpOnly: true, secure: false });
        res.redirect(`${process.env.FRONTEND_URL}/dashboard`);
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
router.get('/link', (req, res) => {
    const cookie = req.cookies['x-refresh-token'];
    cookie ?
        res.redirect(process.env.DISCORD_LINK_URL) :
        res.status(401).json({
            success: false,
            error: 'unauthorized',
        });
});
router.get('/link/callback', OAuthMiddleware_1.default('link'), async (req, res) => {
    const cookie = req.cookies['x-refresh-token'];
    if (!cookie)
        return res.status(401).json({
            success: false,
            error: 'unauthorized',
        });
    try {
        const refreshToken = await RefreshTokenModel_1.default.findOne({ token: cookie });
        if (!refreshToken || Date.now() >= new Date(refreshToken.expires).getTime()) {
            if (refreshToken)
                await refreshToken.remove();
            res.status(401).json({
                success: false,
                error: 'invalid refresh token',
            });
            return;
        }
        const token = jsonwebtoken_1.verify(refreshToken.token, process.env.REFRESH_TOKEN_SECRET);
        const user = await UserModel_1.default.findOne({ _id: token._id })
            .select('-__v -password');
        if (!user)
            return res.status(401).json({
                success: false,
                error: 'invalid session',
            });
        if (!user.emailVerified)
            return res.status(401).json({
                success: false,
                error: 'your email is not verified',
            });
        const { id, avatar, discriminator } = req.discord.user;
        await req.discord.addGuildMember(user);
        let avatarurl;
        if (avatar && avatar.startsWith("a_")) {
            avatarurl = `https://cdn.discordapp.com/${avatar ? `avatars/${id}/${avatar}` : `embed/avatars/${discriminator % 5}`}.gif`;
        }
        else {
            avatarurl = `https://cdn.discordapp.com/${avatar ? `avatars/${id}/${avatar}` : `embed/avatars/${discriminator % 5}`}.png`;
        }
        await UserModel_1.default.findByIdAndUpdate(user._id, {
            discord: {
                id,
                avatar: avatarurl,
            },
        });
        res.status(200).redirect(`${process.env.FRONTEND_URL}/dashboard`);
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: "error: " + err.stack + err,
        });
    }
});
exports.default = router;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGlzY29yZFJvdXRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9yb3V0ZXMvQXV0aFJvdXRlci9EaXNjb3JkUm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEscUNBQW9EO0FBQ3BELCtDQUE0QztBQUM1Qyx3RkFBZ0U7QUFDaEUseUZBQWlFO0FBQ2pFLHVGQUErRDtBQUMvRCx1RUFBK0M7QUFDL0MsTUFBTSxNQUFNLEdBQUcsZ0JBQU0sRUFBRSxDQUFDO0FBRXhCLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQ2pELE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUU5QyxNQUFNLENBQUMsQ0FBQztRQUNKLEdBQUcsQ0FBQyxRQUFRLENBQUMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksWUFBWSxDQUFDLENBQUMsQ0FBQztRQUN2RCxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUNwRCxDQUFDLENBQUMsQ0FBQztBQUVILE1BQU0sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEVBQUUseUJBQWUsRUFBRSxFQUFFLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7SUFDbkYsTUFBTSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFFLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFFdkQsSUFBSTtRQUNBLE1BQU0sSUFBSSxHQUFHLE1BQU0sbUJBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUUzRCxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU07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RyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDakIsT0FBTyxFQUFFLEtBQUs7WUFDZCxLQUFLLEVBQUUsU0FBUyxHQUFHLEdBQUcsQ0FBQyxLQUFLLEdBQUcsR0FBRztTQUNyQyxDQUFDLENBQUM7S0FDTjtBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsa0JBQWUsTUFBTSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgeyBzaWduLCB2ZXJpZnkgfSBmcm9tICdqc29ud2VidG9rZW4nO1xyXG5pbXBvcnQgT0F1dGhNaWRkbGV3YXJlIGZyb20gJy4uLy4uL21pZGRsZXdhcmVzL09BdXRoTWlkZGxld2FyZSc7XHJcbmltcG9ydCBQYXNzd29yZFJlc2V0TW9kZWwgZnJvbSAnLi4vLi4vbW9kZWxzL1Bhc3N3b3JkUmVzZXRNb2RlbCc7XHJcbmltcG9ydCBSZWZyZXNoVG9rZW5Nb2RlbCBmcm9tICcuLi8uLi9tb2RlbHMvUmVmcmVzaFRva2VuTW9kZWwnO1xyXG5pbXBvcnQgVXNlck1vZGVsIGZyb20gJy4uLy4uL21vZGVscy9Vc2VyTW9kZWwnO1xyXG5jb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcclxuXHJcbnJvdXRlci5nZXQoJy9sb2dpbicsIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgIGNvbnN0IGNvb2tpZSA9IHJlcS5jb29raWVzWyd4LXJlZnJlc2gtdG9rZW4nXTtcclxuXHJcbiAgICBjb29raWUgP1xyXG4gICAgICAgIHJlcy5yZWRpcmVjdChgJHtwcm9jZXNzLmVudi5GUk9OVEVORF9VUkx9L2Rhc2hib2FyZGApIDpcclxuICAgICAgICByZXMucmVkaXJlY3QocHJvY2Vzcy5lbnYuRElTQ09SRF9MT0dJTl9VUkwpO1xyXG59KTtcclxuXHJcbnJvdXRlci5nZXQoJy9sb2dpbi9jYWxsYmFjaycsIE9BdXRoTWlkZGxld2FyZSgpLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgICBjb25zdCB7IGlkLCBhdmF0YXIsIGRpc2NyaW1pbmF0b3IgfSA9IHJlcS5kaXNjb3JkLnVzZXI7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlck1vZGVsLmZpbmRPbmUoeyAnZGlzY29yZC5pZCc6IGlkIH0pO1xyXG5cclxuICAgICAgICBpZiAoIXVzZXIgfHwgIXVzZXIuZW1haWxWZXJpZmllZCB8fCB1c2VyLmJsYWNrbGlzdGVkLnN0YXR1cylcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5yZWRpcmVjdChwcm9jZXNzLmVudi5GUk9OVEVORF9VUkwpO1xyXG5cclxuICAgICAgICBjb25zdCBwYXNzd29yZFJlc2V0ID0gYXdhaXQgUGFzc3dvcmRSZXNldE1vZGVsLmZpbmRPbmUoeyB1c2VyOiB1c2VyLl9pZCB9KTtcclxuICAgICAgICBpZiAocGFzc3dvcmRSZXNldCkgYXdhaXQgcGFzc3dvcmRSZXNldC5yZW1vdmUoKTtcclxuICAgICAgICBsZXQgYXZhdGFydXJsXHJcbiAgICAgICAgaWYoYXZhdGFyICYmIGF2YXRhci5zdGFydHNXaXRoKFwiYV9cIikpe1xyXG4gICAgICAgICAgICBhdmF0YXJ1cmwgPSBgaHR0cHM6Ly9jZG4uZGlzY29yZGFwcC5jb20vJHthdmF0YXIgPyBgYXZhdGFycy8ke2lkfS8ke2F2YXRhcn1gIDogYGVtYmVkL2F2YXRhcnMvJHtkaXNjcmltaW5hdG9yICUgNX1gfS5naWZgXHJcbiAgICAgICAgfSBlbHNle1xyXG4gICAgICAgICAgICBhdmF0YXJ1cmwgPSAgYGh0dHBzOi8vY2RuLmRpc2NvcmRhcHAuY29tLyR7YXZhdGFyID8gYGF2YXRhcnMvJHtpZH0vJHthdmF0YXJ9YCA6IGBlbWJlZC9hdmF0YXJzLyR7ZGlzY3JpbWluYXRvciAlIDV9YH0ucG5nYFxyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB1cGRhdGUgPSB7XHJcbiAgICAgICAgICAgICdsYXN0TG9naW4nOiBuZXcgRGF0ZSgpLFxyXG4gICAgICAgICAgICAnZGlzY29yZC5hdmF0YXInOiBhdmF0YXJ1cmwsXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgYXdhaXQgVXNlck1vZGVsLmZpbmRCeUlkQW5kVXBkYXRlKHVzZXIuX2lkLCB1cGRhdGUpO1xyXG4gICAgICAgIGNvbnN0IHJlZnJlc2hUb2tlbiA9IHNpZ24oeyBfaWQ6IHVzZXIuX2lkIH0sIHByb2Nlc3MuZW52LlJFRlJFU0hfVE9LRU5fU0VDUkVUKTtcclxuXHJcbiAgICAgICAgYXdhaXQgUmVmcmVzaFRva2VuTW9kZWwuY3JlYXRlKHtcclxuICAgICAgICAgICAgdG9rZW46IHJlZnJlc2hUb2tlbixcclxuICAgICAgICAgICAgdXNlcjogdXNlci5faWQsXHJcbiAgICAgICAgICAgIGV4cGlyZXM6IG5ldyBEYXRlKG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgNyAqIDI0ICogNjAgKiA2MCAqIDEwMDApLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXMuY29va2llKCd4LXJlZnJlc2gtdG9rZW4nLCByZWZyZXNoVG9rZW4sIHsgaHR0cE9ubHk6IHRydWUsIHNlY3VyZTogZmFsc2UgfSk7XHJcbiAgICAgICAgcmVzLnJlZGlyZWN0KGAke3Byb2Nlc3MuZW52LkZST05URU5EX1VSTH0vZGFzaGJvYXJkYCk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogZXJyLm1lc3NhZ2UsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn0pO1xyXG5cclxucm91dGVyLmdldCgnL2xpbmsnLCAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgICBjb25zdCBjb29raWUgPSByZXEuY29va2llc1sneC1yZWZyZXNoLXRva2VuJ107XHJcblxyXG4gICAgY29va2llID9cclxuICAgICAgICByZXMucmVkaXJlY3QocHJvY2Vzcy5lbnYuRElTQ09SRF9MSU5LX1VSTCkgOlxyXG4gICAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgIGVycm9yOiAndW5hdXRob3JpemVkJyxcclxuICAgICAgICB9KTtcclxufSk7XHJcblxyXG5yb3V0ZXIuZ2V0KCcvbGluay9jYWxsYmFjaycsIE9BdXRoTWlkZGxld2FyZSgnbGluaycpLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgICBjb25zdCBjb29raWUgPSByZXEuY29va2llc1sneC1yZWZyZXNoLXRva2VuJ107XHJcblxyXG4gICAgaWYgKCFjb29raWUpIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgZXJyb3I6ICd1bmF1dGhvcml6ZWQnLFxyXG4gICAgfSk7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCByZWZyZXNoVG9rZW4gPSBhd2FpdCBSZWZyZXNoVG9rZW5Nb2RlbC5maW5kT25lKHsgdG9rZW46IGNvb2tpZSB9KTtcclxuXHJcbiAgICAgICAgaWYgKCFyZWZyZXNoVG9rZW4gfHwgRGF0ZS5ub3coKSA+PSBuZXcgRGF0ZShyZWZyZXNoVG9rZW4uZXhwaXJlcykuZ2V0VGltZSgpKSB7XHJcbiAgICAgICAgICAgIGlmIChyZWZyZXNoVG9rZW4pIGF3YWl0IHJlZnJlc2hUb2tlbi5yZW1vdmUoKTtcclxuXHJcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgZXJyb3I6ICdpbnZhbGlkIHJlZnJlc2ggdG9rZW4nLFxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHRva2VuOiBhbnkgPSB2ZXJpZnkocmVmcmVzaFRva2VuLnRva2VuLCBwcm9jZXNzLmVudi5SRUZSRVNIX1RPS0VOX1NFQ1JFVCk7XHJcblxyXG4gICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyTW9kZWwuZmluZE9uZSh7IF9pZDogdG9rZW4uX2lkIH0pXHJcbiAgICAgICAgICAgIC5zZWxlY3QoJy1fX3YgLXBhc3N3b3JkJyk7XHJcblxyXG4gICAgICAgIGlmICghdXNlcikgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgIGVycm9yOiAnaW52YWxpZCBzZXNzaW9uJyxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaWYgKCF1c2VyLmVtYWlsVmVyaWZpZWQpIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogJ3lvdXIgZW1haWwgaXMgbm90IHZlcmlmaWVkJyxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgeyBpZCwgYXZhdGFyLCBkaXNjcmltaW5hdG9yIH0gPSByZXEuZGlzY29yZC51c2VyO1xyXG5cclxuICAgICAgICBhd2FpdCByZXEuZGlzY29yZC5hZGRHdWlsZE1lbWJlcih1c2VyKTtcclxuICAgICAgICBsZXQgYXZhdGFydXJsXHJcbiAgICAgICAgaWYoYXZhdGFyICYmIGF2YXRhci5zdGFydHNXaXRoKFwiYV9cIikpe1xyXG4gICAgICAgICAgICBhdmF0YXJ1cmwgPSBgaHR0cHM6Ly9jZG4uZGlzY29yZGFwcC5jb20vJHthdmF0YXIgPyBgYXZhdGFycy8ke2lkfS8ke2F2YXRhcn1gIDogYGVtYmVkL2F2YXRhcnMvJHtkaXNjcmltaW5hdG9yICUgNX1gfS5naWZgXHJcbiAgICAgICAgfSBlbHNle1xyXG4gICAgICAgICAgICBhdmF0YXJ1cmwgPSAgYGh0dHBzOi8vY2RuLmRpc2NvcmRhcHAuY29tLyR7YXZhdGFyID8gYGF2YXRhcnMvJHtpZH0vJHthdmF0YXJ9YCA6IGBlbWJlZC9hdmF0YXJzLyR7ZGlzY3JpbWluYXRvciAlIDV9YH0ucG5nYFxyXG4gICAgICAgIH1cclxuICAgICAgICBhd2FpdCBVc2VyTW9kZWwuZmluZEJ5SWRBbmRVcGRhdGUodXNlci5faWQsIHtcclxuICAgICAgICAgICAgZGlzY29yZDoge1xyXG4gICAgICAgICAgICAgICAgaWQsXHJcbiAgICAgICAgICAgICAgICBhdmF0YXI6IGF2YXRhcnVybCxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnJlZGlyZWN0KGAke3Byb2Nlc3MuZW52LkZST05URU5EX1VSTH0vZGFzaGJvYXJkYCk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogXCJlcnJvcjogXCIgKyBlcnIuc3RhY2sgKyBlcnIsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn0pO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgcm91dGVyO1xyXG4iXX0=