"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const MulterUtil_1 = require("../utils/MulterUtil");
const S3Util_1 = require("../utils/S3Util");
const FormatUtil_1 = require("../utils/FormatUtil");
const GenerateUtil_1 = require("../utils/GenerateUtil");
const stream_1 = require("stream");
const UploadMiddleware_1 = __importDefault(require("../middlewares/UploadMiddleware"));
const FileModel_1 = __importDefault(require("../models/FileModel"));
const UserModel_1 = __importDefault(require("../models/UserModel"));
const InvisibleUrlModel_1 = __importDefault(require("../models/InvisibleUrlModel"));
const ValidationMiddleware_1 = __importDefault(require("../middlewares/ValidationMiddleware"));
const DeletionSchema_1 = __importDefault(require("../schemas/DeletionSchema"));
const ConfigSchema_1 = __importDefault(require("../schemas/ConfigSchema"));
const AuthMiddleware_1 = __importDefault(require("../middlewares/AuthMiddleware"));
const archiver_1 = __importDefault(require("archiver"));
const path_1 = require("path");
const CounterModel_1 = __importDefault(require("../models/CounterModel"));
const MailUtil_1 = require("../utils/MailUtil");
const AdminAuthMiddleware_1 = __importDefault(require("../middlewares/AdminAuthMiddleware"));
const rateLimit = require("express-rate-limit");
const router = express_1.Router();
const fileLimiter = rateLimit({
    windowMs: 10 * 1000,
    max: 3,
    headers: false,
});
router.get('/', AdminAuthMiddleware_1.default, async (_req, res) => {
    try {
        const total = await FileModel_1.default.countDocuments();
        const invisibleUrls = await InvisibleUrlModel_1.default.countDocuments();
        const { storageUsed } = await CounterModel_1.default.findById('counter');
        res.status(200).json({
            success: true,
            total,
            invisibleUrls,
            storageUsed: FormatUtil_1.formatFilesize(storageUsed),
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
router.post('/', fileLimiter, UploadMiddleware_1.default, MulterUtil_1.upload.single('file'), async (req, res) => {
    let { file, user, } = req;
    if (!file)
        return res.status(400).json({
            success: false,
            error: 'provide a file',
        });
    if ((file.size > 20971520 && !user.premium) || file.size > 104857600)
        return res.status(413).json({
            success: false,
            error: `your file is too large, your upload limit is: ${user.premium ? '100' : '20'} MB`,
        });
    const { domain, randomDomain, embed, showLink, invisibleUrl } = user.settings;
    let baseUrl = req.headers.domain ?
        req.headers.domain :
        `${domain.subdomain && domain.subdomain !== '' ? `${domain.subdomain}.` : ''}${domain.name}`;
    if (req.headers.randomdomain ? req.headers.randomdomain === 'true' : randomDomain.enabled)
        baseUrl = randomDomain.domains.length > 0 ?
            randomDomain.domains[Math.floor(Math.random() * randomDomain.domains.length)] :
            baseUrl;
    let imageUrl = `https://${baseUrl}/${file.filename}`;
    const deletionKey = GenerateUtil_1.generateString(40);
    const deletionUrl = `${process.env.BACKEND_URL}/files/delete?key=${deletionKey}`;
    const timestamp = new Date();
    file = new FileModel_1.default({
        filename: file.filename,
        key: file.key,
        timestamp,
        mimetype: file.mimetype,
        domain: baseUrl,
        userOnlyDomain: file.userOnlyDomain ? file.userOnlyDomain : false,
        size: FormatUtil_1.formatFilesize(file.size),
        deletionKey,
        embed,
        showLink,
        uploader: {
            uuid: user._id,
            username: user.username,
        },
    });
    file.embed = FormatUtil_1.formatEmbed(embed, user, file);
    await file.save();
    if (req.headers.invisibleurl ? req.headers.invisibleurl === 'true' : invisibleUrl) {
        const invisibleUrlId = GenerateUtil_1.generateInvisibleId();
        await InvisibleUrlModel_1.default.create({
            _id: invisibleUrlId,
            filename: file.filename,
            uploader: user._id,
        });
        imageUrl = `https://${baseUrl}/${invisibleUrlId}`;
    }
    await UserModel_1.default.findByIdAndUpdate(user._id, {
        $inc: {
            uploads: +1,
        },
    });
    res.status(200).json({
        success: true,
        imageUrl,
        deletionUrl,
    });
});
router.get('/delete', ValidationMiddleware_1.default(DeletionSchema_1.default, 'query'), async (req, res) => {
    const deletionKey = req.query.key;
    const file = await FileModel_1.default.findOne({ deletionKey });
    if (!file)
        return res.status(404).json({
            success: false,
            error: 'invalid deletion key',
        });
    const user = await UserModel_1.default.findById(file.uploader.uuid);
    const params = {
        Bucket: process.env.S3_BUCKET,
        Key: file.key,
    };
    try {
        await S3Util_1.s3.deleteObject(params).promise();
        if (user.uploads > 0)
            await UserModel_1.default.findByIdAndUpdate(user._id, {
                $inc: {
                    uploads: -1,
                },
            });
        await file.remove();
        res.status(200).json({
            success: true,
            message: 'deleted file successfully',
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
router.delete('/:id', AuthMiddleware_1.default, async (req, res) => {
    const { id } = req.params;
    const { user } = req;
    const file = await FileModel_1.default.findOne({ filename: id });
    if (!file)
        return res.status(404).json({
            success: false,
            error: 'invalid file',
        });
    if (user._id != file.uploader.uuid)
        return res.status(404).json({
            success: false,
            error: 'not your file',
        });
    const params = {
        Bucket: process.env.S3_BUCKET,
        Key: file.key,
    };
    try {
        await S3Util_1.s3.deleteObject(params).promise();
        if (user.uploads > 0)
            await UserModel_1.default.findByIdAndUpdate(user._id, {
                $inc: {
                    uploads: -1,
                },
            });
        await file.remove();
        res.status(200).json({
            success: true,
            message: 'deleted file successfully',
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
router.post('/wipe', AuthMiddleware_1.default, async (req, res) => {
    const { user } = req;
    try {
        const count = await S3Util_1.wipeFiles(user);
        await FileModel_1.default.deleteMany({
            'uploader.uuid': user._id,
        });
        await InvisibleUrlModel_1.default.deleteMany({
            uploader: user._id,
        });
        await UserModel_1.default.findByIdAndUpdate(user._id, {
            uploads: 0,
        });
        res.status(200).json({
            success: true,
            message: `wiped ${count} files successfully`,
            count,
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
router.get('/config', ValidationMiddleware_1.default(ConfigSchema_1.default, 'query'), async (req, res) => {
    const key = req.query.key;
    const user = await UserModel_1.default.findOne({ key });
    if (!user)
        return res.status(401).json({
            success: false,
            error: 'unauthorized',
        });
    const config = {
        Name: 'dny.wtf file uploader',
        DestinationType: 'ImageUploader, FileUploader',
        RequestType: 'POST',
        RequestURL: `${process.env.BACKEND_URL}/files`,
        FileFormName: 'file',
        Body: 'MultipartFormData',
        Headers: {
            key,
        },
        URL: '$json:imageUrl$',
        DeletionURL: '$json:deletionUrl$',
        ErrorMessage: '$json:error$',
    };
    res.set('Content-Disposition', 'attachment; filename=dny.wtf.sxcu');
    res.send(Buffer.from(JSON.stringify(config, null, 2), 'utf8'));
});
function writeStream(key) {
    const passThrough = new stream_1.PassThrough();
    const params = {
        Bucket: process.env.S3_BUCKET,
        Key: key,
        Body: passThrough,
        ACL: 'public-read',
    };
    return {
        passThrough,
        uploaded: S3Util_1.s3.upload(params, (err) => {
            throw new Error(err);
        }),
    };
}
router.get('/archive', AuthMiddleware_1.default, async (req, res) => {
    const { user } = req;
    if (user.uploads <= 0)
        return res.status(400).json({
            success: false,
            error: 'you haven\'t uploaded any files',
        });
    try {
        const now = Date.now();
        const difference = user.lastFileArchive && now - user.lastFileArchive.getTime();
        const duration = 43200000 - difference;
        if (user.lastFileArchive && duration > 0) {
            const hours = Math.floor(duration / 1000 / 60 / 60);
            const minutes = Math.floor((duration / 1000 / 60 / 60 - hours) * 60);
            const timeLeft = `${hours} hours and ${minutes} minutes`;
            res.status(400).json({
                success: false,
                error: `you cannot create a file archive for another ${timeLeft}`,
            });
            return;
        }
        const params = {
            Bucket: process.env.S3_BUCKET,
            Prefix: `${user._id}/`,
        };
        const objects = await S3Util_1.s3.listObjectsV2(params).promise();
        const streams = objects.Contents.map((object) => {
            return {
                stream: S3Util_1.s3.getObject({ Bucket: process.env.S3_BUCKET, Key: object.Key }).createReadStream(),
                object: object,
            };
        });
        const { passThrough, uploaded } = writeStream(`${user._id}/${GenerateUtil_1.generateString(5)}.zip`);
        await new Promise((resolve, reject) => {
            const archive = archiver_1.default('zip');
            archive.on('error', (err) => {
                throw new Error(err.message);
            });
            passThrough.on('close', resolve);
            passThrough.on('end', resolve);
            passThrough.on('error', reject);
            archive.pipe(passThrough);
            let i = 1;
            streams.forEach((ctx) => {
                if (!ctx.object.Key.endsWith('/') && path_1.extname(ctx.object.Key) !== '.zip') {
                    archive.append(ctx.stream, {
                        name: i.toString() + path_1.extname(ctx.object.Key),
                    });
                    i++;
                }
            });
            archive.finalize();
        }).catch((err) => {
            throw new Error(err);
        });
        const { Key } = await uploaded.promise();
        const Location = `${process.env.S3_ENDPOINT}/${process.env.S3_BUCKET}/${Key}`;
        await MailUtil_1.sendFileArchive(user, S3Util_1.s3.getObject({ Bucket: process.env.S3_BUCKET, Key }).createReadStream());
        await UserModel_1.default.findByIdAndUpdate(user._id, {
            lastFileArchive: new Date(),
        });
        res.status(200).json({
            success: true,
            message: 'sent archive to your email successfully',
            directLink: Location,
        });
    }
    catch (err) {
        res.status(500).json({
            success: false,
            error: err.message,
        });
    }
});
exports.default = router;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRmlsZXNSb3V0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcm91dGVzL0ZpbGVzUm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEscUNBQW9EO0FBQ3BELG9EQUE2QztBQUM3Qyw0Q0FBZ0Q7QUFDaEQsb0RBQWtFO0FBQ2xFLHdEQUE0RTtBQUU1RSxtQ0FBcUM7QUFDckMsdUZBQStEO0FBQy9ELG9FQUFzRDtBQUN0RCxvRUFBc0Q7QUFDdEQsb0ZBQTREO0FBQzVELCtGQUF1RTtBQUN2RSwrRUFBdUQ7QUFDdkQsMkVBQW1EO0FBQ25ELG1GQUEyRDtBQUMzRCx3REFBZ0M7QUFDaEMsK0JBQStCO0FBQy9CLDBFQUFrRDtBQUNsRCxnREFBb0Q7QUFDcEQsNkZBQXFFO0FBQ3JFLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBRWhELE1BQU0sTUFBTSxHQUFHLGdCQUFNLEVBQUUsQ0FBQztBQUN4QixNQUFNLFdBQVcsR0FBRyxTQUFTLENBQUM7SUFDMUIsUUFBUSxFQUFFLEVBQUUsR0FBRyxJQUFJO0lBQ25CLEdBQUcsRUFBRSxDQUFDO0lBQ04sT0FBTyxFQUFFLEtBQUs7Q0FDakIsQ0FBQyxDQUFDO0FBRUgsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsNkJBQW1CLEVBQUMsS0FBSyxFQUFFLElBQWEsRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUN2RSxJQUFJO1FBQ0EsTUFBTSxLQUFLLEdBQUcsTUFBTSxtQkFBUyxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQy9DLE1BQU0sYUFBYSxHQUFHLE1BQU0sMkJBQWlCLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDL0QsTUFBTSxFQUFFLFdBQVcsRUFBRSxHQUFHLE1BQU0sc0JBQVksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDL0QsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFD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SUFBSTtZQUNiLE9BQU8sRUFBRSx5Q0FBeUM7WUFDbEQsVUFBVSxFQUFFLFFBQVE7U0FDdkIsQ0FBQyxDQUFDO0tBQ047SUFBQyxPQUFPLEdBQUcsRUFBRTtRQUNWLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ2pCLE9BQU8sRUFBRSxLQUFLO1lBQ2QsS0FBSyxFQUFFLEdBQUcsQ0FBQyxPQUFPO1NBQ3JCLENBQUMsQ0FBQztLQUNOO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxrQkFBZSxNQUFNLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgUm91dGVyIH0gZnJvbSAnZXhwcmVzcyc7XHJcbmltcG9ydCB7IHVwbG9hZCB9IGZyb20gJy4uL3V0aWxzL011bHRlclV0aWwnO1xyXG5pbXBvcnQgeyBzMywgd2lwZUZpbGVzIH0gZnJvbSAnLi4vdXRpbHMvUzNVdGlsJztcclxuaW1wb3J0IHsgZm9ybWF0RW1iZWQsIGZvcm1hdEZpbGVzaXplIH0gZnJvbSAnLi4vdXRpbHMvRm9ybWF0VXRpbCc7XHJcbmltcG9ydCB7IGdlbmVyYXRlU3RyaW5nLCBnZW5lcmF0ZUludmlzaWJsZUlkIH0gZnJvbSAnLi4vdXRpbHMvR2VuZXJhdGVVdGlsJztcclxuaW1wb3J0IHsgRG9jdW1lbnRUeXBlIH0gZnJvbSAnQHR5cGVnb29zZS90eXBlZ29vc2UnO1xyXG5pbXBvcnQgeyBQYXNzVGhyb3VnaCB9IGZyb20gJ3N0cmVhbSc7XHJcbmltcG9ydCBVcGxvYWRNaWRkbGV3YXJlIGZyb20gJy4uL21pZGRsZXdhcmVzL1VwbG9hZE1pZGRsZXdhcmUnO1xyXG5pbXBvcnQgRmlsZU1vZGVsLCB7IEZpbGUgfSBmcm9tICcuLi9tb2RlbHMvRmlsZU1vZGVsJztcclxuaW1wb3J0IFVzZXJNb2RlbCwgeyBVc2VyIH0gZnJvbSAnLi4vbW9kZWxzL1VzZXJNb2RlbCc7XHJcbmltcG9ydCBJbnZpc2libGVVcmxNb2RlbCBmcm9tICcuLi9tb2RlbHMvSW52aXNpYmxlVXJsTW9kZWwnO1xyXG5pbXBvcnQgVmFsaWRhdGlvbk1pZGRsZXdhcmUgZnJvbSAnLi4vbWlkZGxld2FyZXMvVmFsaWRhdGlvbk1pZGRsZXdhcmUnO1xyXG5pbXBvcnQgRGVsZXRpb25TY2hlbWEgZnJvbSAnLi4vc2NoZW1hcy9EZWxldGlvblNjaGVtYSc7XHJcbmltcG9ydCBDb25maWdTY2hlbWEgZnJvbSAnLi4vc2NoZW1hcy9Db25maWdTY2hlbWEnO1xyXG5pbXBvcnQgQXV0aE1pZGRsZXdhcmUgZnJvbSAnLi4vbWlkZGxld2FyZXMvQXV0aE1pZGRsZXdhcmUnO1xyXG5pbXBvcnQgQXJjaGl2ZXIgZnJvbSAnYXJjaGl2ZXInO1xyXG5pbXBvcnQgeyBleHRuYW1lIH0gZnJvbSAncGF0aCc7XHJcbmltcG9ydCBDb3VudGVyTW9kZWwgZnJvbSBcIi4uL21vZGVscy9Db3VudGVyTW9kZWxcIjtcclxuaW1wb3J0IHsgc2VuZEZpbGVBcmNoaXZlIH0gZnJvbSAnLi4vdXRpbHMvTWFpbFV0aWwnO1xyXG5pbXBvcnQgQWRtaW5BdXRoTWlkZGxld2FyZSBmcm9tIFwiLi4vbWlkZGxld2FyZXMvQWRtaW5BdXRoTWlkZGxld2FyZVwiO1xyXG5jb25zdCByYXRlTGltaXQgPSByZXF1aXJlKFwiZXhwcmVzcy1yYXRlLWxpbWl0XCIpO1xyXG5cclxuY29uc3Qgcm91dGVyID0gUm91dGVyKCk7XHJcbmNvbnN0IGZpbGVMaW1pdGVyID0gcmF0ZUxpbWl0KHtcclxuICAgIHdpbmRvd01zOiAxMCAqIDEwMDAsXHJcbiAgICBtYXg6IDMsXHJcbiAgICBoZWFkZXJzOiBmYWxzZSxcclxufSk7XHJcblxyXG5yb3V0ZXIuZ2V0KCcvJywgQWRtaW5BdXRoTWlkZGxld2FyZSxhc3luYyAoX3JlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCB0b3RhbCA9IGF3YWl0IEZpbGVNb2RlbC5jb3VudERvY3VtZW50cygpO1xyXG4gICAgICAgIGNvbnN0IGludmlzaWJsZVVybHMgPSBhd2FpdCBJbnZpc2libGVVcmxNb2RlbC5jb3VudERvY3VtZW50cygpO1xyXG4gICAgICAgIGNvbnN0IHsgc3RvcmFnZVVzZWQgfSA9IGF3YWl0IENvdW50ZXJNb2RlbC5maW5kQnlJZCgnY291bnRlcicpO1xyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICAgICAgdG90YWwsXHJcbiAgICAgICAgICAgIGludmlzaWJsZVVybHMsXHJcbiAgICAgICAgICAgIHN0b3JhZ2VVc2VkOiBmb3JtYXRGaWxlc2l6ZShzdG9yYWdlVXNlZCksXHJcbiAgICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogZXJyLm1lc3NhZ2UsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn0pO1xyXG5cclxucm91dGVyLnBvc3QoJy8nLGZpbGVMaW1pdGVyLCBVcGxvYWRNaWRkbGV3YXJlLCB1cGxvYWQuc2luZ2xlKCdmaWxlJyksIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgIGxldCB7XHJcbiAgICAgICAgZmlsZSxcclxuICAgICAgICB1c2VyLFxyXG4gICAgfToge1xyXG4gICAgICAgIGZpbGU6IEV4cHJlc3MuTXVsdGVyLkZpbGUgfCBEb2N1bWVudFR5cGU8RmlsZT4sXHJcbiAgICAgICAgdXNlcjogVXNlclxyXG4gICAgfSA9IHJlcTtcclxuXHJcbiAgICBpZiAoIWZpbGUpIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgZXJyb3I6ICdwcm92aWRlIGEgZmlsZScsXHJcbiAgICB9KTtcclxuICAgIGlmICgoZmlsZS5zaXplID4gMjA5NzE1MjAgJiYgIXVzZXIucHJlbWl1bSkgfHwgZmlsZS5zaXplID4gMTA0ODU3NjAwKSByZXR1cm4gcmVzLnN0YXR1cyg0MTMpLmpzb24oe1xyXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgIGVycm9yOiBgeW91ciBmaWxlIGlzIHRvbyBsYXJnZSwgeW91ciB1cGxvYWQgbGltaXQgaXM6ICR7XHJcbiAgICAgICAgICAgIHVzZXIucHJlbWl1bSA/ICcxMDAnIDogJzIwJ1xyXG4gICAgICAgIH0gTUJgLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgeyBkb21haW4sIHJhbmRvbURvbWFpbiwgZW1iZWQsIHNob3dMaW5rLCBpbnZpc2libGVVcmwgfSA9IHVzZXIuc2V0dGluZ3M7XHJcblxyXG4gICAgbGV0IGJhc2VVcmwgPSByZXEuaGVhZGVycy5kb21haW4gP1xyXG4gICAgICAgIHJlcS5oZWFkZXJzLmRvbWFpbiA6XHJcbiAgICAgICAgYCR7ZG9tYWluLnN1YmRvbWFpbiAmJiBkb21haW4uc3ViZG9tYWluICE9PSAnJyA/IGAke2RvbWFpbi5zdWJkb21haW59LmAgOiAnJ30ke2RvbWFpbi5uYW1lfWA7XHJcblxyXG4gICAgaWYgKHJlcS5oZWFkZXJzLnJhbmRvbWRvbWFpbiA/IHJlcS5oZWFkZXJzLnJhbmRvbWRvbWFpbiA9PT0gJ3RydWUnIDogcmFuZG9tRG9tYWluLmVuYWJsZWQpIGJhc2VVcmwgPSByYW5kb21Eb21haW4uZG9tYWlucy5sZW5ndGggPiAwID9cclxuICAgICAgICByYW5kb21Eb21haW4uZG9tYWluc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiByYW5kb21Eb21haW4uZG9tYWlucy5sZW5ndGgpXSA6XHJcbiAgICAgICAgYmFzZVVybDtcclxuXHJcbiAgICBsZXQgaW1hZ2VVcmwgPSBgaHR0cHM6Ly8ke2Jhc2VVcmx9LyR7ZmlsZS5maWxlbmFtZX1gO1xyXG5cclxuICAgIGNvbnN0IGRlbGV0aW9uS2V5ID0gZ2VuZXJhdGVTdHJpbmcoNDApO1xyXG4gICAgY29uc3QgZGVsZXRpb25VcmwgPSBgJHtwcm9jZXNzLmVudi5CQUNLRU5EX1VSTH0vZmlsZXMvZGVsZXRlP2tleT0ke2RlbGV0aW9uS2V5fWA7XHJcbiAgICBjb25zdCB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpO1xyXG5cclxuICAgIGZpbGUgPSBuZXcgRmlsZU1vZGVsKHtcclxuICAgICAgICBmaWxlbmFtZTogZmlsZS5maWxlbmFtZSxcclxuICAgICAgICBrZXk6IGZpbGUua2V5LFxyXG4gICAgICAgIHRpbWVzdGFtcCxcclxuICAgICAgICBtaW1ldHlwZTogZmlsZS5taW1ldHlwZSxcclxuICAgICAgICBkb21haW46IGJhc2VVcmwsXHJcbiAgICAgICAgdXNlck9ubHlEb21haW46IGZpbGUudXNlck9ubHlEb21haW4gPyBmaWxlLnVzZXJPbmx5RG9tYWluIDogZmFsc2UsXHJcbiAgICAgICAgc2l6ZTogZm9ybWF0RmlsZXNpemUoZmlsZS5zaXplKSxcclxuICAgICAgICBkZWxldGlvbktleSxcclxuICAgICAgICBlbWJlZCxcclxuICAgICAgICBzaG93TGluayxcclxuICAgICAgICB1cGxvYWRlcjoge1xyXG4gICAgICAgICAgICB1dWlkOiB1c2VyLl9pZCxcclxuICAgICAgICAgICAgdXNlcm5hbWU6IHVzZXIudXNlcm5hbWUsXHJcbiAgICAgICAgfSxcclxuICAgIH0pO1xyXG5cclxuICAgIGZpbGUuZW1iZWQgPSBmb3JtYXRFbWJlZChlbWJlZCwgdXNlciwgZmlsZSk7XHJcblxyXG4gICAgYXdhaXQgZmlsZS5zYXZlKCk7XHJcblxyXG4gICAgaWYgKHJlcS5oZWFkZXJzLmludmlzaWJsZXVybCA/IHJlcS5oZWFkZXJzLmludmlzaWJsZXVybCA9PT0gJ3RydWUnIDogaW52aXNpYmxlVXJsKSB7XHJcbiAgICAgICAgY29uc3QgaW52aXNpYmxlVXJsSWQgPSBnZW5lcmF0ZUludmlzaWJsZUlkKCk7XHJcblxyXG4gICAgICAgIGF3YWl0IEludmlzaWJsZVVybE1vZGVsLmNyZWF0ZSh7XHJcbiAgICAgICAgICAgIF9pZDogaW52aXNpYmxlVXJsSWQsXHJcbiAgICAgICAgICAgIGZpbGVuYW1lOiBmaWxlLmZpbGVuYW1lLFxyXG4gICAgICAgICAgICB1cGxvYWRlcjogdXNlci5faWQsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGltYWdlVXJsID0gYGh0dHBzOi8vJHtiYXNlVXJsfS8ke2ludmlzaWJsZVVybElkfWA7XHJcbiAgICB9XHJcblxyXG4gICAgYXdhaXQgVXNlck1vZGVsLmZpbmRCeUlkQW5kVXBkYXRlKHVzZXIuX2lkLCB7XHJcbiAgICAgICAgJGluYzoge1xyXG4gICAgICAgICAgICB1cGxvYWRzOiArMSxcclxuICAgICAgICB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmVzLnN0YXR1cygyMDApLmpzb24oe1xyXG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgaW1hZ2VVcmwsXHJcbiAgICAgICAgZGVsZXRpb25VcmwsXHJcbiAgICB9KTtcclxufSk7XHJcblxyXG5yb3V0ZXIuZ2V0KCcvZGVsZXRlJywgVmFsaWRhdGlvbk1pZGRsZXdhcmUoRGVsZXRpb25TY2hlbWEsICdxdWVyeScpLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgICBjb25zdCBkZWxldGlvbktleSA9IHJlcS5xdWVyeS5rZXkgYXMgc3RyaW5nO1xyXG4gICAgY29uc3QgZmlsZSA9IGF3YWl0IEZpbGVNb2RlbC5maW5kT25lKHsgZGVsZXRpb25LZXkgfSk7XHJcblxyXG4gICAgaWYgKCFmaWxlKSByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xyXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgIGVycm9yOiAnaW52YWxpZCBkZWxldGlvbiBrZXknLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXJNb2RlbC5maW5kQnlJZChmaWxlLnVwbG9hZGVyLnV1aWQpO1xyXG5cclxuICAgIGNvbnN0IHBhcmFtcyA9IHtcclxuICAgICAgICBCdWNrZXQ6IHByb2Nlc3MuZW52LlMzX0JVQ0tFVCxcclxuICAgICAgICBLZXk6IGZpbGUua2V5LFxyXG4gICAgfTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIGF3YWl0IHMzLmRlbGV0ZU9iamVjdChwYXJhbXMpLnByb21pc2UoKTtcclxuXHJcbiAgICAgICAgaWYgKHVzZXIudXBsb2FkcyA+IDApIGF3YWl0IFVzZXJNb2RlbC5maW5kQnlJZEFuZFVwZGF0ZSh1c2VyLl9pZCwge1xyXG4gICAgICAgICAgICAkaW5jOiB7XHJcbiAgICAgICAgICAgICAgICB1cGxvYWRzOiAtMSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgYXdhaXQgZmlsZS5yZW1vdmUoKTtcclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICAgICAgICBtZXNzYWdlOiAnZGVsZXRlZCBmaWxlIHN1Y2Nlc3NmdWxseScsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogZXJyLm1lc3NhZ2UsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn0pO1xyXG5cclxucm91dGVyLmRlbGV0ZSgnLzppZCcsIEF1dGhNaWRkbGV3YXJlLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xyXG4gICAgY29uc3QgeyB1c2VyIH0gPSByZXE7XHJcblxyXG4gICAgY29uc3QgZmlsZSA9IGF3YWl0IEZpbGVNb2RlbC5maW5kT25lKHsgZmlsZW5hbWU6IGlkIH0pO1xyXG5cclxuICAgIGlmICghZmlsZSkgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogJ2ludmFsaWQgZmlsZScsXHJcbiAgICB9KTtcclxuICAgIGlmICh1c2VyLl9pZCAhPSBmaWxlLnVwbG9hZGVyLnV1aWQpIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgZXJyb3I6ICdub3QgeW91ciBmaWxlJyxcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IHBhcmFtcyA9IHtcclxuICAgICAgICBCdWNrZXQ6IHByb2Nlc3MuZW52LlMzX0JVQ0tFVCxcclxuICAgICAgICBLZXk6IGZpbGUua2V5LFxyXG4gICAgfTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIGF3YWl0IHMzLmRlbGV0ZU9iamVjdChwYXJhbXMpLnByb21pc2UoKTtcclxuXHJcbiAgICAgICAgaWYgKHVzZXIudXBsb2FkcyA+IDApIGF3YWl0IFVzZXJNb2RlbC5maW5kQnlJZEFuZFVwZGF0ZSh1c2VyLl9pZCwge1xyXG4gICAgICAgICAgICAkaW5jOiB7XHJcbiAgICAgICAgICAgICAgICB1cGxvYWRzOiAtMSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgYXdhaXQgZmlsZS5yZW1vdmUoKTtcclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICAgICAgICBtZXNzYWdlOiAnZGVsZXRlZCBmaWxlIHN1Y2Nlc3NmdWxseScsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogZXJyLm1lc3NhZ2UsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn0pO1xyXG5cclxucm91dGVyLnBvc3QoJy93aXBlJywgQXV0aE1pZGRsZXdhcmUsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgIGNvbnN0IHsgdXNlciB9ID0gcmVxO1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgY291bnQgPSBhd2FpdCB3aXBlRmlsZXModXNlcik7XHJcblxyXG4gICAgICAgIGF3YWl0IEZpbGVNb2RlbC5kZWxldGVNYW55KHtcclxuICAgICAgICAgICAgJ3VwbG9hZGVyLnV1aWQnOiB1c2VyLl9pZCxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgYXdhaXQgSW52aXNpYmxlVXJsTW9kZWwuZGVsZXRlTWFueSh7XHJcbiAgICAgICAgICAgIHVwbG9hZGVyOiB1c2VyLl9pZCxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgYXdhaXQgVXNlck1vZGVsLmZpbmRCeUlkQW5kVXBkYXRlKHVzZXIuX2lkLCB7XHJcbiAgICAgICAgICAgIHVwbG9hZHM6IDAsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgICAgICAgbWVzc2FnZTogYHdpcGVkICR7Y291bnR9IGZpbGVzIHN1Y2Nlc3NmdWxseWAsXHJcbiAgICAgICAgICAgIGNvdW50LFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgZXJyb3I6IGVyci5tZXNzYWdlLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59KTtcclxuXHJcbnJvdXRlci5nZXQoJy9jb25maWcnLCBWYWxpZGF0aW9uTWlkZGxld2FyZShDb25maWdTY2hlbWEsICdxdWVyeScpLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgICBjb25zdCBrZXkgPSByZXEucXVlcnkua2V5IGFzIHN0cmluZztcclxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyTW9kZWwuZmluZE9uZSh7IGtleSB9KTtcclxuXHJcbiAgICBpZiAoIXVzZXIpIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XHJcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgZXJyb3I6ICd1bmF1dGhvcml6ZWQnLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgY29uZmlnID0ge1xyXG4gICAgICAgIE5hbWU6ICdkbnkud3RmIGZpbGUgdXBsb2FkZXInLFxyXG4gICAgICAgIERlc3RpbmF0aW9uVHlwZTogJ0ltYWdlVXBsb2FkZXIsIEZpbGVVcGxvYWRlcicsXHJcbiAgICAgICAgUmVxdWVzdFR5cGU6ICdQT1NUJyxcclxuICAgICAgICBSZXF1ZXN0VVJMOiBgJHtwcm9jZXNzLmVudi5CQUNLRU5EX1VSTH0vZmlsZXNgLFxyXG4gICAgICAgIEZpbGVGb3JtTmFtZTogJ2ZpbGUnLFxyXG4gICAgICAgIEJvZHk6ICdNdWx0aXBhcnRGb3JtRGF0YScsXHJcbiAgICAgICAgSGVhZGVyczoge1xyXG4gICAgICAgICAgICBrZXksXHJcbiAgICAgICAgfSxcclxuICAgICAgICBVUkw6ICckanNvbjppbWFnZVVybCQnLFxyXG4gICAgICAgIERlbGV0aW9uVVJMOiAnJGpzb246ZGVsZXRpb25VcmwkJyxcclxuICAgICAgICBFcnJvck1lc3NhZ2U6ICckanNvbjplcnJvciQnLFxyXG4gICAgfTtcclxuXHJcbiAgICByZXMuc2V0KCdDb250ZW50LURpc3Bvc2l0aW9uJywgJ2F0dGFjaG1lbnQ7IGZpbGVuYW1lPWRueS53dGYuc3hjdScpO1xyXG4gICAgcmVzLnNlbmQoQnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkoY29uZmlnLCBudWxsLCAyKSwgJ3V0ZjgnKSk7XHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gd3JpdGVTdHJlYW0oa2V5OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHBhc3NUaHJvdWdoID0gbmV3IFBhc3NUaHJvdWdoKCk7XHJcblxyXG4gICAgY29uc3QgcGFyYW1zID0ge1xyXG4gICAgICAgIEJ1Y2tldDogcHJvY2Vzcy5lbnYuUzNfQlVDS0VULFxyXG4gICAgICAgIEtleToga2V5LFxyXG4gICAgICAgIEJvZHk6IHBhc3NUaHJvdWdoLFxyXG4gICAgICAgIEFDTDogJ3B1YmxpYy1yZWFkJyxcclxuICAgIH07XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBwYXNzVGhyb3VnaCxcclxuICAgICAgICB1cGxvYWRlZDogczMudXBsb2FkKHBhcmFtcywgKGVycikgPT4ge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyKTtcclxuICAgICAgICB9KSxcclxuICAgIH07XHJcbn1cclxuXHJcbnJvdXRlci5nZXQoJy9hcmNoaXZlJywgQXV0aE1pZGRsZXdhcmUsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgIGNvbnN0IHsgdXNlciB9ID0gcmVxO1xyXG5cclxuICAgIGlmICh1c2VyLnVwbG9hZHMgPD0gMCkgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBlcnJvcjogJ3lvdSBoYXZlblxcJ3QgdXBsb2FkZWQgYW55IGZpbGVzJyxcclxuICAgIH0pO1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICBjb25zdCBkaWZmZXJlbmNlID0gdXNlci5sYXN0RmlsZUFyY2hpdmUgJiYgbm93IC0gdXNlci5sYXN0RmlsZUFyY2hpdmUuZ2V0VGltZSgpO1xyXG4gICAgICAgIGNvbnN0IGR1cmF0aW9uID0gNDMyMDAwMDAgLSBkaWZmZXJlbmNlO1xyXG5cclxuICAgICAgICBpZiAodXNlci5sYXN0RmlsZUFyY2hpdmUgJiYgZHVyYXRpb24gPiAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGhvdXJzID0gTWF0aC5mbG9vcihkdXJhdGlvbiAvIDEwMDAgLyA2MCAvIDYwKTtcclxuICAgICAgICAgICAgY29uc3QgbWludXRlcyA9IE1hdGguZmxvb3IoKGR1cmF0aW9uIC8gMTAwMCAvIDYwIC8gNjAgLSBob3VycykgKiA2MCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHRpbWVMZWZ0ID0gYCR7aG91cnN9IGhvdXJzIGFuZCAke21pbnV0ZXN9IG1pbnV0ZXNgO1xyXG5cclxuICAgICAgICAgICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBlcnJvcjogYHlvdSBjYW5ub3QgY3JlYXRlIGEgZmlsZSBhcmNoaXZlIGZvciBhbm90aGVyICR7dGltZUxlZnR9YCxcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBwYXJhbXMgPSB7XHJcbiAgICAgICAgICAgIEJ1Y2tldDogcHJvY2Vzcy5lbnYuUzNfQlVDS0VULFxyXG4gICAgICAgICAgICBQcmVmaXg6IGAke3VzZXIuX2lkfS9gLFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGNvbnN0IG9iamVjdHMgPSBhd2FpdCBzMy5saXN0T2JqZWN0c1YyKHBhcmFtcykucHJvbWlzZSgpO1xyXG4gICAgICAgIGNvbnN0IHN0cmVhbXMgPSBvYmplY3RzLkNvbnRlbnRzLm1hcCgob2JqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBzdHJlYW06IHMzLmdldE9iamVjdCh7IEJ1Y2tldDogcHJvY2Vzcy5lbnYuUzNfQlVDS0VULCBLZXk6IG9iamVjdC5LZXkgfSkuY3JlYXRlUmVhZFN0cmVhbSgpLFxyXG4gICAgICAgICAgICAgICAgb2JqZWN0OiBvYmplY3QsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHsgcGFzc1Rocm91Z2gsIHVwbG9hZGVkIH0gPSB3cml0ZVN0cmVhbShgJHt1c2VyLl9pZH0vJHtnZW5lcmF0ZVN0cmluZyg1KX0uemlwYCk7XHJcblxyXG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgYXJjaGl2ZSA9IEFyY2hpdmVyKCd6aXAnKTtcclxuXHJcbiAgICAgICAgICAgIGFyY2hpdmUub24oJ2Vycm9yJywgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVyci5tZXNzYWdlKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBwYXNzVGhyb3VnaC5vbignY2xvc2UnLCByZXNvbHZlKTtcclxuICAgICAgICAgICAgcGFzc1Rocm91Z2gub24oJ2VuZCcsIHJlc29sdmUpO1xyXG4gICAgICAgICAgICBwYXNzVGhyb3VnaC5vbignZXJyb3InLCByZWplY3QpO1xyXG5cclxuICAgICAgICAgICAgYXJjaGl2ZS5waXBlKHBhc3NUaHJvdWdoKTtcclxuXHJcbiAgICAgICAgICAgIGxldCBpID0gMTtcclxuXHJcbiAgICAgICAgICAgIHN0cmVhbXMuZm9yRWFjaCgoY3R4KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWN0eC5vYmplY3QuS2V5LmVuZHNXaXRoKCcvJykgJiYgZXh0bmFtZShjdHgub2JqZWN0LktleSkgIT09ICcuemlwJykge1xyXG4gICAgICAgICAgICAgICAgICAgIGFyY2hpdmUuYXBwZW5kKGN0eC5zdHJlYW0sIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogaS50b1N0cmluZygpICsgZXh0bmFtZShjdHgub2JqZWN0LktleSksXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGkrKztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBhcmNoaXZlLmZpbmFsaXplKCk7XHJcbiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgeyBLZXkgfSA9IGF3YWl0IHVwbG9hZGVkLnByb21pc2UoKTtcclxuICAgICAgICBjb25zdCBMb2NhdGlvbiA9IGAke3Byb2Nlc3MuZW52LlMzX0VORFBPSU5UfS8ke3Byb2Nlc3MuZW52LlMzX0JVQ0tFVH0vJHtLZXl9YDtcclxuXHJcbiAgICAgICAgYXdhaXQgc2VuZEZpbGVBcmNoaXZlKHVzZXIsIHMzLmdldE9iamVjdCh7IEJ1Y2tldDogcHJvY2Vzcy5lbnYuUzNfQlVDS0VULCBLZXkgfSkuY3JlYXRlUmVhZFN0cmVhbSgpKTtcclxuXHJcbiAgICAgICAgYXdhaXQgVXNlck1vZGVsLmZpbmRCeUlkQW5kVXBkYXRlKHVzZXIuX2lkLCB7XHJcbiAgICAgICAgICAgIGxhc3RGaWxlQXJjaGl2ZTogbmV3IERhdGUoKSxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICAgICAgICBtZXNzYWdlOiAnc2VudCBhcmNoaXZlIHRvIHlvdXIgZW1haWwgc3VjY2Vzc2Z1bGx5JyxcclxuICAgICAgICAgICAgZGlyZWN0TGluazogTG9jYXRpb24sXHJcbiAgICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgICAgICBlcnJvcjogZXJyLm1lc3NhZ2UsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn0pO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgcm91dGVyO1xyXG4iXX0=